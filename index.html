<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Exam | Next Gen</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <!-- Math Rendering -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        bn: ['Hind Siliguri', 'sans-serif'],
                        en: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'float-cap': 'floatCap 3s ease-in-out infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        floatCap: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
                            '50%': { transform: 'translateY(-10px) rotate(-5deg) scale(1.1)' }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; }
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Exam & Math Styles */
        .ans-card.correct { border-color: #10b981; } .dark .ans-card.correct { background: #10b9811a; }
        .ans-card.wrong { border-color: #ef4444; } .dark .ans-card.wrong { background: #ef44441a; }
        .opt-res.right { background: #d1fae5; border-color: #10b981; color: #047857; font-weight: bold; }
        .dark .opt-res.right { background-color: #059669; border-color: #10b981; color: #d1fae5;}
        .opt-res.wrong-select { background: #fee2e2; border-color: #ef4444; color: #b91c1c; text-decoration: line-through; }
        .dark .opt-res.wrong-select { background-color: #b91c1c; border-color: #ef4444; color: #fee2e2;}
        .nav-item.active { color: #6366f1; transform: translateY(-2px); }
        .opt-btn.selected { background-color: #6366f1; color: white; border-color: #6366f1; font-weight: bold; }
        
        /* MathQuill - Improved Visibility */
        .math-editor-container { 
            border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; 
            padding: 0.5rem; 
            background-color: white;
            min-height: 50px;
            position: relative;
        }
        .dark .math-editor-container { 
            border-color: #4b5563; 
            background-color: #1f2937;
        }
        .math-editor-field { 
            width: 100%; 
            font-size: 16px; 
            color: #1e293b;
            min-height: 40px;
        }
        .dark .math-editor-field {
            color: #f1f5f9;
        }
        .mq-editable-field {
            width: 100% !important;
            min-height: 40px !important;
            color: #1e293b !important;
            font-size: 16px !important;
            padding: 8px !important;
            background-color: transparent !important;
        }
        .dark .mq-editable-field {
            color: #f1f5f9 !important;
        }
        .mq-root-block, .mq-math-mode {
            color: #1e293b !important;
        }
        .dark .mq-root-block, .dark .mq-math-mode {
            color: #f1f5f9 !important;
        }
        .mq-textarea {
            color: #1e293b !important;
            caret-color: #6366f1 !important;
        }
        .dark .mq-textarea {
            color: #f1f5f9 !important;
            caret-color: #818cf8 !important;
        }
        .mq-cursor {
            border-left: 2px solid #6366f1 !important;
        }
        .dark .mq-cursor {
            border-left: 2px solid #818cf8 !important;
        }
        
        /* Math Toolbar */
        .math-toolbar { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 4px; 
            margin-bottom: 8px; 
            padding: 8px; 
            background-color: #f8fafc; 
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .dark .math-toolbar { 
            background-color: #374151; 
            border-color: #4b5563;
        }
        .math-toolbar button { 
            width: 36px; 
            height: 36px; 
            font-size: 14px; 
            font-weight: bold; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            background-color: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark .math-toolbar button { 
            background-color: #4b5563; 
            border-color: #6b7280;
            color: #e5e7eb;
        }
        .math-toolbar button:hover {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
            transform: translateY(-1px);
        }
        
        /* Math Toolbar Toggle Button */
        .math-toolbar-toggle {
            margin-bottom: 0.5rem;
        }
        .toggle-math-toolbar {
            transition: all 0.2s ease-in-out;
        }
        .toggle-math-toolbar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        .toggle-math-toolbar.active {
            background-color: #4f46e5 !important;
            color: white !important;
        }
        
        /* Math Dropdown */
        .math-dropdown { 
            position: relative; 
            display: inline-block; 
        }
        .math-dropdown-btn { 
            width: 36px; 
            height: 36px; 
            font-size: 14px; 
            font-weight: bold; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            background-color: white; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .dark .math-dropdown-btn { 
            background-color: #4b5563; 
            border-color: #6b7280;
            color: #e5e7eb;
        }
        .math-dropdown-btn:hover {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        .math-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 280px;
            max-width: 300px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 5px;
        }
        .dark .math-dropdown-content {
            background-color: #1f2937;
            border-color: #4b5563;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .math-dropdown-content.show {
            display: grid !important;
            animation: fadeIn 0.2s ease-out;
        }
        .math-dropdown-content button {
            padding: 8px 4px;
            font-size: 13px;
            text-align: center;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background-color: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
            word-break: break-word;
            line-height: 1.2;
        }
        .dark .math-dropdown-content button {
            background-color: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        .math-dropdown-content button:hover {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
            transform: translateY(-1px);
        }
        .math-char-btn {
            font-family: "Times New Roman", serif;
            font-weight: bold;
        }
        
        /* Question Form Improvements */
        .question-input-container {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .dark .question-input-container {
            background-color: #1f2937;
            border-color: #4b5563;
        }
        .question-label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .dark .question-label {
            color: #94a3b8;
        }
        
        /* Math Preview Toggle */
        .math-preview-toggle {
            position: absolute;
            right: 8px;
            top: 8px;
            z-index: 10;
        }
        
        /* Folder Structure */
        .folder-icon {
            color: #f59e0b;
        }
        .file-icon {
            color: #3b82f6;
        }
        .live-folder-icon {
            color: #ef4444;
        }
        .mock-folder-icon {
            color: #10b981;
        }
        
        /* New Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Folder Card Hover Effects */
        .folder-card:hover .folder-icon-container {
            animation: bounceIn 0.5s ease;
        }

        .folder-card:hover i.fa-arrow-right {
            transform: translateX(5px);
            transition: transform 0.3s ease;
        }

        /* Subject Folder Animation */
        .subject-header i.fa-chevron-down {
            transition: transform 0.3s ease;
        }

        .subject-header[aria-expanded="true"] i.fa-chevron-down {
            transform: rotate(180deg);
        }

        /* Exam Item Hover Animation */
        .exam-item:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #6366f1;
        }

        .dark .exam-item:hover {
            border-color: #818cf8;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Publishing Animation */
        @keyframes publishSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .publish-success {
            animation: publishSuccess 0.6s ease;
        }
        
        /* Math Editor Textarea improved styles */
        .math-editor-container textarea {
            min-height: 80px;
            font-family: 'Hind Siliguri', 'Arial', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background-color: white;
        }
        
        .dark .math-editor-container textarea {
            background-color: #1f2937;
            border-color: #4b5563;
            color: #f1f5f9;
        }
        
        .math-editor-container textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Toggle button styles */
        .toggle-math-toolbar {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dark .toggle-math-toolbar {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        
        .toggle-math-toolbar:hover {
            background-color: #e2e8f0;
            border-color: #94a3b8;
        }
        
        .dark .toggle-math-toolbar:hover {
            background-color: #4b5563;
            border-color: #6b7280;
        }
        
        .toggle-math-toolbar.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .math-dropdown-btn.active {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5 !important;
        }
        
        /* টগল সুইচ স্টাইল */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d1d5db;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-switch::before {
            background-color: #4f46e5;
        }

        .toggle-switch input:checked + .toggle-switch::after {
            transform: translateX(20px);
        }
        
        /* মোবাইল স্ক্রিনে টুলবার টগল বোতাম কেন্দ্রে রাখার জন্য */
        @media (max-width: 640px) {
          .math-toolbar-toggle {
            display: flex;
            justify-content: center;
            margin: 10px auto;
          }
          
          .toggle-math-toolbar {
            width: 100%;
            max-width: 280px;
            justify-content: center;
          }
          
          /* মোবাইল ভিউতে ইউজার ড্যাশবোর্ডের জন্য স্টাইল */
          #teacher-header {
            padding: 0.75rem 1rem;
          }
          
          #teacher-header .font-bold {
            font-size: 0.9rem;
          }
          
          #teacher-header button {
            padding: 0.25rem;
          }
          
          .user-management-header {
            flex-direction: column;
            gap: 1rem;
          }
          
          .user-management-header > div:first-child {
            width: 100%;
            justify-content: flex-start;
          }
          
          .user-management-header .relative {
            width: 100%;
          }
          
          #user-search {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
          }
        }
    </style>

    <!-- UI Scripts (Non-module) -->
    <script>
        // ==========================================
        // UI & HELPERS (Defined FIRST for Robustness)
        // ==========================================
        
        const AuthUI = {
            switch: (t) => {
                const sForm = document.getElementById('form-student');
                const tForm = document.getElementById('form-teacher');
                const sTab = document.getElementById('tab-student');
                const tTab = document.getElementById('tab-teacher');
                const indicator = document.getElementById('tab-indicator');

                if (t === 'student') {
                    if (sForm) sForm.classList.remove('hidden');
                    if (tForm) tForm.classList.add('hidden');
                    if (indicator) indicator.style.transform = 'translateX(0)';
                    if (sTab) {
                        sTab.classList.add('text-indigo-600', 'dark:text-white');
                        sTab.classList.remove('text-slate-500', 'dark:text-slate-400');
                    }
                    if (tTab) {
                        tTab.classList.add('text-slate-500', 'dark:text-slate-400');
                        tTab.classList.remove('text-slate-800', 'dark:text-white');
                    }
                } else {
                    if (sForm) sForm.classList.add('hidden');
                    if (tForm) tForm.classList.remove('hidden');
                    if (indicator) indicator.style.transform = 'translateX(100%)';
                    if (tTab) {
                        tTab.classList.add('text-slate-800', 'dark:text-white');
                        tTab.classList.remove('text-slate-500', 'dark:text-slate-400');
                    }
                    if (sTab) {
                        sTab.classList.add('text-slate-500', 'dark:text-slate-400');
                        sTab.classList.remove('text-indigo-600', 'dark:text-white');
                    }
                }
            },
            togglePass: (id, el) => { 
                const i = document.getElementById(id); 
                if (i && i.type === 'password') { 
                    i.type = 'text'; 
                    el.classList.replace('fa-eye', 'fa-eye-slash');
                    el.classList.add('text-indigo-600');
                } else if (i) { 
                    i.type = 'password'; 
                    el.classList.replace('fa-eye-slash', 'fa-eye'); 
                    el.classList.remove('text-indigo-600');
                } 
            }
        };
        
        window.AuthUI = AuthUI;

        const Theme = {
            init: () => { 
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { 
                    document.documentElement.classList.add('dark'); 
                } else { 
                    document.documentElement.classList.remove('dark'); 
                } 
                Theme.updateIcon(); 
            },
            toggle: () => { 
                if (localStorage.theme === 'dark') { 
                    localStorage.theme = 'light'; 
                } else { 
                    localStorage.theme = 'dark'; 
                } 
                Theme.init(); 
            },
            updateIcon: () => { 
                const btn = document.getElementById('theme-toggle-btn'); 
                if (btn) btn.innerHTML = document.documentElement.classList.contains('dark') ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; 
                const btn2 = document.getElementById('theme-toggle-btn-user'); 
                if (btn2) btn2.innerHTML = document.documentElement.classList.contains('dark') ? '<i class="fas fa-sun"></i> Switch Theme' : '<i class="fas fa-moon"></i> Switch Theme'; 
            }
        };
        window.Theme = Theme;
        
        // Math Helper Functions
        window.MathHelper = {
            showMathHelp: (fieldId) => {
                Swal.fire({
                    title: 'গাণিতিক সূত্র লেখার সহায়িকা',
                    html: `
                    <div class="text-left space-y-3">
                        <p class="font-bold text-indigo-600 dark:text-indigo-400">সাধারণ নির্দেশনা:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>সরাসরি অক্ষর লিখতে পারেন (a, b, x, y)</li>
                            <li>সাধারণ টেক্সট লিখতে পারেন (প্রশ্ন, ব্যাখ্যা)</li>
                            <li>গাণিতিক চিহ্ন যোগ করতে উপরের বাটনগুলো ব্যবহার করুন</li>
                            <li>বাংলা ও ইংরেজি উভয় ভাষাতেই লিখতে পারেন</li>
                        </ul>
                        <p class="mt-3 font-bold text-emerald-600 dark:text-emerald-400">কিছু দরকারি টিপস:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><code>\\frac{লব}{হর}</code> - ভগ্নাংশের জন্য</li>
                            <li><code>\\sqrt{সংখ্যা}</code> - বর্গমূলের জন্য</li>
                            <li><code>x^2</code> - ঘাতের জন্য</li>
                            <li><code>x_1</code> - সাবস্ক্রিপ্টের জন্য</li>
                            <li><code>\\left| x \\right|</code> - পরম মানের জন্য</li>
                            <li><code>\\frac{d}{dx}</code> - অন্তরীকরণের জন্য</li>
                            <li><code>\\int_a^b</code> - নির্দিষ্ট যোগজের জন্য</li>
                        </ul>
                    </div>`,
                    icon: 'info',
                    confirmButtonText: 'বুঝেছি',
                    width: '600px'
                });
            },
            
            insertMathSymbol: (fieldId, symbol, emptyBrackets = '') => {
                const mathField = window.mathFields?.[fieldId];
                if (mathField) {
                    try {
                        mathField.focus();
                        
                        // Special handling for root symbols
                        if (symbol === '\\\\sqrt') {
                            mathField.writeLatex('\\sqrt{}');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\sqrt[n]{}') {
                            mathField.writeLatex('\\sqrt[n]{}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\sqrt[3]{}') {
                            mathField.writeLatex('\\sqrt[3]{}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        }
                        
                        // Improved arrow symbols
                        if (symbol === '\\\\rightarrow') {
                            mathField.writeLatex('\\rightarrow');
                            return;
                        } else if (symbol === '\\\\leftarrow') {
                            mathField.writeLatex('\\leftarrow');
                            return;
                        } else if (symbol === '\\\\uparrow') {
                            mathField.writeLatex('\\uparrow');
                            return;
                        } else if (symbol === '\\\\downarrow') {
                            mathField.writeLatex('\\downarrow');
                            return;
                        } else if (symbol === '\\\\leftrightarrow') {
                            mathField.writeLatex('\\leftrightarrow');
                            return;
                        } else if (symbol === '\\\\Rightarrow') {
                            mathField.writeLatex('\\Rightarrow');
                            return;
                        } else if (symbol === '\\\\Leftarrow') {
                            mathField.writeLatex('\\Leftarrow');
                            return;
                        } else if (symbol === '\\\\Leftrightarrow') {
                            mathField.writeLatex('\\Leftrightarrow');
                            return;
                        } else if (symbol === '\\\\mapsto') {
                            mathField.writeLatex('\\mapsto');
                            return;
                        } else if (symbol === '\\\\to') {
                            mathField.writeLatex('\\to');
                            return;
                        }
                        
                        // Special handling for calculus symbols
                        if (symbol === '\\\\frac{d}{dx}') {
                            mathField.writeLatex('\\frac{d}{dx}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\frac{\\\\partial}{\\\\partial x}') {
                            mathField.writeLatex('\\frac{\\partial}{\\partial x}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\int_a^b') {
                            mathField.writeLatex('\\int_{a}^{b}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\oint') {
                            mathField.writeLatex('\\oint');
                            return;
                        } else if (symbol === '\\\\nabla') {
                            mathField.writeLatex('\\nabla');
                            return;
                        } else if (symbol === '\\\\Delta') {
                            mathField.writeLatex('\\Delta');
                            return;
                        } else if (symbol === '\\\\vec{x}') {
                            mathField.writeLatex('\\vec{x}');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\overrightarrow{AB}') {
                            mathField.writeLatex('\\overrightarrow{AB}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\overleftarrow{AB}') {
                            mathField.writeLatex('\\overleftarrow{AB}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\overleftrightarrow{AB}') {
                            mathField.writeLatex('\\overleftrightarrow{AB}');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\hat{x}') {
                            mathField.writeLatex('\\hat{x}');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\bar{x}') {
                            mathField.writeLatex('\\bar{x}');
                            mathField.keystroke('Left');
                            return;
                        } else if (symbol === '\\\\underline{x}') {
                            mathField.writeLatex('\\underline{x}');
                            mathField.keystroke('Left');
                            return;
                        }
                        
                        // Handle fraction specially
                        if (symbol === '\\\\frac') {
                            mathField.cmd('\\frac');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                        } else if (symbol.startsWith('\\\\left')) {
                            // Handle brackets with left/right
                            if (symbol === '\\\\left| ') {
                                mathField.writeLatex('\\left| \\right|');
                            } else if (symbol === '\\\\left\\\\{ ') {
                                mathField.writeLatex('\\left\\{ \\right\\}');
                            } else if (symbol === '\\\\left\\\\| ') {
                                mathField.writeLatex('\\left\\| \\right\\|');
                            } else {
                                const bracket = symbol.slice(6).trim();
                                mathField.writeLatex(`\\left${bracket} \\right${bracket}`);
                            }
                            // Move cursor between brackets
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                            mathField.keystroke('Left');
                        } else {
                            // Regular symbols
                            mathField.cmd(symbol);
                            
                            // Handle empty brackets for superscript/subscript
                            if (emptyBrackets === '{}') {
                                mathField.keystroke('Left');
                            }
                        }
                        
                        // Ensure focus stays
                        setTimeout(() => mathField.focus(), 10);
                    } catch (error) {
                        console.error('Error inserting math symbol:', error);
                        // Fallback method
                        try {
                            const currentLatex = mathField.latex();
                            mathField.latex(currentLatex + symbol);
                            mathField.focus();
                        } catch (e) {
                            console.error('Fallback also failed:', e);
                        }
                    }
                }
            },
            
            setupMathDropdowns: () => {
                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    const isDropdownBtn = e.target.closest('.math-dropdown-btn');
                    const isInsideDropdown = e.target.closest('.math-dropdown-content');
                    
                    if (!isDropdownBtn && !isInsideDropdown) {
                        document.querySelectorAll('.math-dropdown-content').forEach(dropdown => {
                            dropdown.style.display = 'none';
                            dropdown.classList.remove('show');
                        });
                    }
                });
                
                // Toggle dropdown on button click
                document.querySelectorAll('.math-dropdown-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Close other dropdowns
                        document.querySelectorAll('.math-dropdown-content').forEach(dropdown => {
                            if (dropdown !== btn.parentElement.querySelector('.math-dropdown-content')) {
                                dropdown.style.display = 'none';
                                dropdown.classList.remove('show');
                            }
                        });
                        
                        const dropdown = btn.parentElement.querySelector('.math-dropdown-content');
                        if (dropdown) {
                            if (dropdown.style.display === 'grid' || dropdown.classList.contains('show')) {
                                dropdown.style.display = 'none';
                                dropdown.classList.remove('show');
                            } else {
                                dropdown.style.display = 'grid';
                                dropdown.classList.add('show');
                                // Position dropdown properly
                                const rect = btn.getBoundingClientRect();
                                dropdown.style.left = '0';
                                dropdown.style.right = 'auto';
                                
                                // Adjust if it goes off screen
                                const dropdownRect = dropdown.getBoundingClientRect();
                                if (dropdownRect.right > window.innerWidth) {
                                    dropdown.style.left = 'auto';
                                    dropdown.style.right = '0';
                                }
                            }
                        }
                    });
                });
                
                // Prevent dropdown from closing when clicking inside
                document.querySelectorAll('.math-dropdown-content').forEach(dropdown => {
                    dropdown.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });
            },
            
            toggleMathToolbar: (fieldId) => {
                const toolbar = document.getElementById(`math-toolbar-${fieldId}`);
                const toggleBtn = toolbar?.previousElementSibling?.querySelector('button');
                
                if (toolbar) {
                    if (toolbar.classList.contains('hidden')) {
                        toolbar.classList.remove('hidden');
                        if (toggleBtn) {
                            toggleBtn.classList.add('active');
                            toggleBtn.querySelector('i.fa-chevron-down').classList.replace('fa-chevron-down', 'fa-chevron-up');
                        }
                        
                        // Set up dropdowns after showing toolbar
                        setTimeout(() => {
                            window.MathHelper.setupMathDropdowns();
                        }, 50);
                    } else {
                        toolbar.classList.add('hidden');
                        if (toggleBtn) {
                            toggleBtn.classList.remove('active');
                            toggleBtn.querySelector('i.fa-chevron-up').classList.replace('fa-chevron-up', 'fa-chevron-down');
                        }
                    }
                }
            }
        };
        
        // Attach UI Listeners IMMEDIATELY
        function attachUIListeners() {
            console.log('Attaching UI listeners...');
            
            // Auth Switchers
            const tS = document.getElementById('tab-student');
            const tT = document.getElementById('tab-teacher');
            if(tS) {
                console.log('Found student tab');
                tS.addEventListener('click', () => {
                    console.log('Student tab clicked');
                    AuthUI.switch('student');
                });
            }
            if(tT) {
                console.log('Found teacher tab');
                tT.addEventListener('click', () => {
                    console.log('Teacher tab clicked');
                    AuthUI.switch('teacher');
                });
            }
            
            // Pass Toggles
            const pS = document.getElementById('s-pass-toggle');
            const pT = document.getElementById('t-pass-toggle');
            if(pS) {
                console.log('Found student pass toggle');
                pS.addEventListener('click', (e) => {
                    console.log('Student pass toggle clicked');
                    AuthUI.togglePass('s-pass', e.currentTarget);
                });
            }
            if(pT) {
                console.log('Found teacher pass toggle');
                pT.addEventListener('click', (e) => {
                    console.log('Teacher pass toggle clicked');
                    AuthUI.togglePass('t-pass', e.currentTarget);
                });
            }
            
            // Theme
            const thBtn = document.getElementById('theme-toggle-btn');
            if(thBtn) {
                console.log('Found theme toggle');
                thBtn.addEventListener('click', Theme.toggle);
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing UI...');
            Theme.init();
            attachUIListeners();
        });
    </script>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 h-screen flex flex-col overflow-hidden selection:bg-indigo-500 selection:text-white">

    <!-- NEW MODERN AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-slate-50 dark:bg-slate-900 flex items-center justify-center p-4">
        <!-- Animated Background Blobs -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
            <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-indigo-400 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
            <div class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-purple-400 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
            <div class="absolute -bottom-32 left-20 w-96 h-96 bg-pink-400 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
        </div>

        <!-- Glassmorphism Card -->
        <div class="relative z-10 w-full max-w-md bg-white/70 dark:bg-slate-800/60 backdrop-blur-xl border border-white/50 dark:border-slate-700/50 rounded-3xl shadow-2xl p-8 flex flex-col items-center">
            
            <!-- Logo Section WITH NEW ANIMATION -->
            <div class="mb-6 text-center">
                <!-- Added 'animate-float-cap' here -->
                <div class="w-16 h-16 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center text-white text-2xl mb-4 mx-auto animate-float-cap">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-800 dark:text-white font-en tracking-tight">Smart<span class="text-indigo-600">Exam</span></h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">The Ultimate Exam Platform</p>
            </div>

            <!-- Modern Tab Switcher -->
            <div class="bg-slate-200/50 dark:bg-slate-700/50 p-1.5 rounded-xl flex w-full mb-8 relative">
                <div id="tab-indicator" class="absolute left-1.5 top-1.5 bottom-1.5 w-[calc(50%-6px)] bg-white dark:bg-slate-600 rounded-lg shadow-sm transition-all duration-300 ease-in-out"></div>
                <button id="tab-student" class="flex-1 relative z-10 py-2.5 text-sm font-bold text-indigo-600 dark:text-white transition-colors duration-300">Student</button>
                <button id="tab-teacher" class="flex-1 relative z-10 py-2.5 text-sm font-bold text-slate-500 dark:text-slate-400 transition-colors duration-300 hover:text-slate-700 dark:hover:text-slate-200">Teacher</button>
            </div>

            <!-- Student Form -->
            <div id="form-student" class="w-full space-y-4 animate-[fadeIn_0.3s_ease-out]">
                <div class="space-y-4">
                    <div class="relative group">
                        <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="email" id="s-email" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:border-indigo-500 dark:focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/10 transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500 font-en" placeholder="Email Address">
                    </div>
                    <div class="relative group">
                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="password" id="s-pass" class="w-full pl-11 pr-11 py-3.5 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:border-indigo-500 dark:focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/10 transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500 font-en" placeholder="Password">
                        <i id="s-pass-toggle" class="fas fa-eye absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer hover:text-indigo-500 transition p-1"></i>
                    </div>
                </div>
                
                <button id="s-login-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-500/30 transform transition active:scale-[0.98] flex items-center justify-center gap-2">
                    <span>Log In</span> <i class="fas fa-arrow-right text-xs"></i>
                </button>
                
                <div class="text-center pt-2">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Don't have an account? <button id="s-signup-btn" class="text-indigo-600 dark:text-indigo-400 font-bold hover:underline">Sign Up</button></p>
                </div>
            </div>

            <!-- Teacher Form -->
            <div id="form-teacher" class="w-full space-y-4 hidden animate-[fadeIn_0.3s_ease-out]">
                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg flex gap-3 items-center mb-2">
                    <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-800 flex items-center justify-center text-blue-600 dark:text-blue-400"><i class="fas fa-chalkboard-teacher"></i></div>
                    <div class="text-xs text-blue-800 dark:text-blue-200 font-bold">For Teachers & Educators Only</div>
                </div>
                <div class="space-y-4">
                    <div class="relative group">
                        <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-slate-800 dark:group-focus-within:text-white transition-colors"></i>
                        <input type="email" id="t-email" class="w-full pl-11 pr-4 py-3.5 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:border-slate-800 dark:focus:border-slate-400 focus:ring-4 focus:ring-slate-500/10 transition-all font-en" placeholder="Teacher Email">
                    </div>
                    <div class="relative group">
                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-slate-800 dark:group-focus-within:text-white transition-colors"></i>
                        <input type="password" id="t-pass" class="w-full pl-11 pr-11 py-3.5 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-600 rounded-xl outline-none focus:border-slate-800 dark:focus:border-slate-400 focus:ring-4 focus:ring-slate-500/10 transition-all font-en" placeholder="Teacher Password">
                        <i id="t-pass-toggle" class="fas fa-eye absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer hover:text-slate-800 transition p-1"></i>
                    </div>
                </div>
                <button id="t-login-btn" class="w-full bg-blue-700 dark:bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg transform transition active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i> <span>Teacher Login</span>
                </button>
                <div class="text-center pt-2">
                    <p class="text-sm text-slate-500 dark:text-slate-400">New teacher? <button id="t-signup-btn" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Register</button></p>
                </div>
            </div>
        </div>
        <div class="absolute bottom-4 text-slate-400 text-xs font-en opacity-60">
            &copy; 2026 SmartExam Inc.
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <main id="app-container" class="flex-1 overflow-y-auto hidden pb-24 scroll-smooth"></main>
    <div id="demo-exit-btn" class="fixed bottom-24 right-4 z-50 hidden"><button id="demo-exit-actual-btn" class="bg-red-600 text-white px-4 py-3 rounded-full shadow-lg font-bold text-sm flex items-center gap-2 animate-bounce"><i class="fas fa-sign-out-alt"></i> Exit Demo</button></div>
    
    <!-- NAVIGATION BARS -->
    <nav id="student-nav" class="fixed bottom-0 w-full bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-t dark:border-slate-700 h-16 flex justify-around items-center z-40 hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <button data-route="dashboard" class="nav-item text-indigo-600 flex flex-col items-center"><i class="fas fa-home text-xl"></i><span class="text-[10px] font-bold mt-1">হোম</span></button>
        <button data-route="rank" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-trophy text-xl"></i><span class="text-[10px] font-bold mt-1">র‍্যাংক</span></button>
        <button data-route="results" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-clipboard-list text-xl"></i><span class="text-[10px] font-bold mt-1">ফলাফল</span></button>
        <button data-route="profile" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-user-circle text-xl"></i><span class="text-[10px] font-bold mt-1">প্রোফাইল</span></button>
    </nav>
    
    <nav id="teacher-nav" class="fixed bottom-0 w-full bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-t dark:border-slate-700 h-16 flex justify-around items-center z-40 hidden">
        <button data-route="create" class="nav-item text-blue-600 flex flex-col items-center"><i class="fas fa-plus-circle text-xl"></i><span class="text-[10px] font-bold">Create</span></button>
        <button data-route="rank" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-trophy text-xl"></i><span class="text-[10px] font-bold">Rank</span></button>
        <button data-route="management" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-tasks text-xl"></i><span class="text-[10px] font-bold">Manage</span></button>
        <button data-route="teacher-profile" class="nav-item text-slate-400 flex flex-col items-center"><i class="fas fa-user-tie text-xl"></i><span class="text-[10px] font-bold">Profile</span></button>
    </nav>

    <div id="teacher-header" class="fixed top-0 w-full bg-white/80 dark:bg-slate-800/80 backdrop-blur border-b dark:border-slate-700 h-14 flex justify-between items-center px-4 z-40 hidden">
        <div class="font-bold font-en text-slate-800 dark:text-white">Teacher<span class="text-blue-600 dark:text-blue-400">Panel</span></div>
        <div class="flex gap-2 items-center">
            <button id="theme-toggle-btn" class="text-slate-500 hover:text-blue-600 px-2"><i class="fas fa-moon"></i></button>
            <button id="teacher-demo-btn" class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold border border-emerald-200">Demo</button>
            <button id="teacher-logout-btn" class="text-red-500 hover:text-red-700 px-2"><i class="fas fa-power-off"></i></button>
        </div>
    </div>

    <!-- Main Logic Script (Module) -->
<script type="module">
    /// Firebase SDK imports (CDN Links for Browser)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, arrayUnion, arrayRemove, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCSH6ooErxpspQUvecZP2cygnUWo3R9i2s",
      authDomain: "exam-plus-b7404.firebaseapp.com",
      projectId: "exam-plus-b7404",
      storageBucket: "exam-plus-b7404.firebasestorage.app",
      messagingSenderId: "105597305444",
      appId: "1:105597305444:web:293b0e529d558fa28fd571",
      measurementId: "G-71TQ0C4K96"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    console.log("Firebase initialized successfully");
    };
     // Initialize Firebase with better error handling
    try {
        // app = initializeApp(firebaseConfig);
        // auth = getAuth(app);
        // db = getFirestore(app);
        console.log("Firebase initialized successfully");
        
        // Mock objects for testing without Firebase
        auth = {
            currentUser: null,
            signInWithEmailAndPassword: async () => ({ user: { uid: 'test', email: 'test@test.com', displayName: 'Test User' } }),
            createUserWithEmailAndPassword: async () => ({ user: { uid: 'test', email: 'test@test.com' } }),
            signOut: async () => {},
            onAuthStateChanged: (callback) => { callback(auth.currentUser); return () => {}; }
        };
        
        db = {
            collection: () => ({
                where: () => ({ orderBy: () => ({}) }),
                orderBy: () => ({})
            }),
            doc: () => ({}),
            getDocs: async () => ({ empty: true, forEach: () => {} }),
            getDoc: async () => ({ exists: () => false, data: () => ({}) }),
            setDoc: async () => {},
            updateDoc: async () => {},
            deleteDoc: async () => {},
            addDoc: async () => ({ id: 'test-id' }),
            query: () => {},
            where: () => {},
            orderBy: () => {},
            onSnapshot: () => () => {},
            arrayUnion: () => {},
            arrayRemove: () => {},
            writeBatch: () => ({ delete: () => {}, commit: async () => {} })
        };
        
    } catch (error) {
        console.error("Firebase Init Error:", error);
        // Show more user-friendly error
        Swal.fire({
            title: "System Error",
            html: `
                <div class="text-left">
                    <p class="mb-2">Database connection failed. Please check:</p>
                    <ul class="list-disc pl-5 text-sm">
                        <li>Internet connection</li>
                        <li>Firebase project configuration</li>
                        <li>Browser permissions</li>
                    </ul>
                    <p class="mt-4 text-xs text-slate-500">Error: ${error.message}</p>
                </div>
            `,
            icon: 'error',
            confirmButtonText: 'Retry',
            allowOutsideClick: false
        }).then(() => {
            location.reload();
        });
    }

    const AppState = { role: 'guest', user: null, isDemo: false };
    window.AppState = AppState;

    const ExamCache = {}; 
    window.ExamCache = ExamCache;

    const unsubscribes = [];
    window.unsubscribes = unsubscribes;

    const mathFields = {};
    window.mathFields = mathFields;

    const clearListeners = () => { 
        unsubscribes.forEach(u => u()); 
        unsubscribes.length = 0; 
    };

    const initGlobalCache = () => { 
        if(!db) return;
        try {
            const unsub = onSnapshot(query(collection(db, "exams"), orderBy("createdAt", "desc")), (snap) => { 
                window.ExamCache = {}; 
                snap.forEach(d => { 
                    window.ExamCache[d.id] = { id: d.id, ...d.data() }; 
                }); 
                if (document.getElementById('app-container').offsetParent) MathJax.typesetPromise(); 
            });
            unsubscribes.push(unsub);
        } catch (error) {
            console.error("Cache initialization error:", error);
        }
    };
    
    // Teacher কোড ভ্যালিডেশন ফাংশন
    const validateTeacherCode = (code) => {
        const pattern = /^[A-Z]{5}-\d{5}$/;
        return pattern.test(code);
    };

    const generateTeacherCode = () => {
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let code = '';
        
        // প্রথম ৫টা বড় অক্ষর
        for (let i = 0; i < 5; i++) {
            code += letters.charAt(Math.floor(Math.random() * letters.length));
        }
        
        code += '-';
        
        // শেষ ৫টা সংখ্যা
        for (let i = 0; i < 5; i++) {
            code += Math.floor(Math.random() * 10);
        }
        
        return code;
    };

    const Auth = {
        studentLogin: async () => {
            if(!auth || !db) {
                Swal.fire("System Error", "Database connection not available. Please refresh the page.", "error");
                return;
            }
            
            const btn = document.getElementById('s-login-btn');
            const email = document.getElementById('s-email').value.trim();
            const pass = document.getElementById('s-pass').value;
            
            if(!email || !pass) {
                Swal.fire('Required','Please enter both email and password','warning');
                return;
            }

            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div> Processing...';
            btn.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                console.log("Student login successful:", userCredential.user.email);
                
                // Check if user exists in Firestore
                const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
                if (!userDoc.exists()) {
                    // Create user profile if it doesn't exist
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name: userCredential.user.displayName || email.split('@')[0],
                        email: email,
                        role: 'student',
                        blocked: false,
                        disabled: false,
                        joined: new Date()
                    });
                }
                
                // Load user session
                loadUserSession(userCredential.user);
                
            } catch(e) {
                console.error("Login error details:", e);
                let errorMessage = e.message.replace('Firebase: ', '');
                
                // User-friendly error messages
                if (e.code === 'auth/user-not-found') {
                    errorMessage = "No account found with this email. Please sign up first.";
                } else if (e.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect password. Please try again.";
                } else if (e.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed attempts. Please try again later.";
                } else if (e.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format. Please check your email.";
                } else if (e.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Please check your internet connection.";
                }
                
                Swal.fire({
                    title: 'Login Failed',
                    text: errorMessage,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        },
        
        studentSignup: async () => {
            if(!auth || !db) {
                Swal.fire("System Error", "Database connection not available. Please refresh the page.", "error");
                return;
            }
            
            try {
                const { value: formValues } = await Swal.fire({ 
                    title: 'Create Student Account', 
                    html: `
                        <input id="swal-name" class="swal2-input" placeholder="Full Name" required>
                        <input id="swal-email" class="swal2-input" placeholder="Email Address" type="email" required>
                        <input id="swal-password" class="swal2-input" placeholder="Password (min 6 characters)" type="password" required>
                        <input id="swal-teacher-code" class="swal2-input" placeholder="Teacher Code (Optional)" id="student-teacher-code">
                        <div class="text-xs text-slate-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Enter your teacher's code to connect with them (Format: ABCDE-12345)
                        </div>
                    `, 
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Create Account',
                    confirmButtonColor: '#4f46e5',
                    preConfirm: () => {
                        return [
                            document.getElementById('swal-name').value.trim(),
                            document.getElementById('swal-email').value.trim(),
                            document.getElementById('swal-password').value,
                            document.getElementById('swal-teacher-code').value.trim()
                        ];
                    },
                    validationMessage: 'Please fill in all fields'
                });
                
                if (formValues) {
                    const [name, email, password, teacherCode] = formValues;
                    
                    // Validation
                    if (!name || !email || !password) {
                        throw new Error("Name, email and password are required.");
                    }
                    
                    if (password.length < 6) {
                        throw new Error("Password must be at least 6 characters long.");
                    }
                    
                    // Check if email already exists as teacher
                    const teacherCheck = await getDocs(query(collection(db, "teachers"), where("email", "==", email)));
                    if (!teacherCheck.empty) {
                        throw new Error("This email is already registered as a teacher. Students cannot use teacher email.");
                    }
                    
                    // Show loading
                    Swal.fire({
                        title: 'Creating account...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Update profile
                    await updateProfile(userCredential.user, { displayName: name });
                    
                    let teacherId = null;
                    let teacherName = null;
                    
                    // Process teacher code if provided
                    if (teacherCode) {
                        if (!validateTeacherCode(teacherCode)) {
                            throw new Error("Invalid teacher code format. Use ABCDE-12345 format.");
                        }
                        
                        // Find teacher by code
                        const teacherQuery = await getDocs(query(collection(db, "teachers"), where("teacherCode", "==", teacherCode)));
                        
                        if (!teacherQuery.empty) {
                            const teacherDoc = teacherQuery.docs[0];
                            const teacherData = teacherDoc.data();
                            
                            teacherId = teacherDoc.id;
                            teacherName = teacherData.name;
                            
                            // Add student to teacher's students array
                            await updateDoc(doc(db, "teachers", teacherId), {
                                students: arrayUnion(userCredential.user.uid)
                            });
                        } else {
                            Swal.fire({
                                title: 'Teacher Not Found',
                                text: `No teacher found with code: ${teacherCode}. You can still create account without teacher.`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Continue Anyway',
                                cancelButtonText: 'Try Different Code'
                            }).then((result) => {
                                if (!result.isConfirmed) {
                                    throw new Error("Please enter a valid teacher code or leave empty.");
                                }
                            });
                        }
                    }
                    
                    // Create student document
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name: name,
                        email: email,
                        role: 'student',
                        blocked: false,
                        disabled: false,
                        joined: new Date(),
                        createdAt: new Date(),
                        teacherId: teacherId,
                        teacherName: teacherName,
                        teacherCode: teacherCode || null
                    });
                    
                    Swal.fire({
                        title: 'Success!',
                        text: teacherId ? `Account created and connected to teacher: ${teacherName}` : 'Account created successfully.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        loadUserSession(userCredential.user);
                    });
                }
            } catch(e) {
                console.error("Student signup error:", e);
                let errorMessage = e.message.replace('Firebase: ', '');
                
                if (e.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already registered. Please use a different email or login.";
                } else if (e.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak. Please use a stronger password.";
                } else if (e.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format. Please check your email.";
                }
                
                Swal.fire('Signup Failed', errorMessage, 'error');
            }
        },
        
        teacherSignup: async () => {
            if(!auth || !db) {
                Swal.fire("System Error", "Database connection not available. Please refresh the page.", "error");
                return;
            }
            
            try {
                const { value: formValues } = await Swal.fire({ 
                    title: 'Teacher Registration', 
                    html: `
                        <input id="swal-name" class="swal2-input" placeholder="Full Name" required>
                        <input id="swal-email" class="swal2-input" placeholder="Email Address" type="email" required>
                        <input id="swal-password" class="swal2-input" placeholder="Password (min 6 characters)" type="password" required>
                        <input id="swal-teacher-code" class="swal2-input" placeholder="Create Teacher Code (ABCDE-12345)" required>
                        <div class="text-xs text-slate-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Format: 5 capital letters, hyphen, 5 numbers (e.g., ABCDE-12345)
                        </div>
                        <div class="text-xs text-amber-600 dark:text-amber-400 mt-1">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Once registered, this code cannot be changed!
                        </div>
                    `, 
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Register as Teacher',
                    confirmButtonColor: '#1d4ed8',
                    preConfirm: () => {
                        return [
                            document.getElementById('swal-name').value.trim(),
                            document.getElementById('swal-email').value.trim(),
                            document.getElementById('swal-password').value,
                            document.getElementById('swal-teacher-code').value.trim()
                        ];
                    },
                    validationMessage: 'Please fill in all fields'
                });
                
                if (formValues) {
                    const [name, email, password, teacherCode] = formValues;
                    
                    // Validation
                    if (!name || !email || !password || !teacherCode) {
                        throw new Error("All fields are required.");
                    }
                    
                    if (password.length < 6) {
                        throw new Error("Password must be at least 6 characters long.");
                    }
                    
                    // Teacher code validation
                    if (!validateTeacherCode(teacherCode)) {
                        throw new Error("Invalid teacher code format. Use ABCDE-12345 format.");
                    }
                    
                    // Check if teacher code already exists
                    const teacherCodeCheck = await getDocs(query(collection(db, "teachers"), where("teacherCode", "==", teacherCode)));
                    if (!teacherCodeCheck.empty) {
                        throw new Error("This teacher code is already taken. Please choose another one.");
                    }
                    
                    // Check if email already exists as student
                    const studentCheck = await getDocs(query(collection(db, "users"), where("email", "==", email), where("role", "==", "student")));
                    if (!studentCheck.empty) {
                        throw new Error("This email is already registered as a student. Please use a different email for teacher account.");
                    }
                    
                    // Check if email already exists as teacher
                    const teacherCheck = await getDocs(query(collection(db, "teachers"), where("email", "==", email)));
                    if (!teacherCheck.empty) {
                        throw new Error("This email is already registered as a teacher. Please login instead.");
                    }
                    
                    // Show loading
                    Swal.fire({
                        title: 'Creating teacher account...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Create user in Firebase Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Update profile
                    await updateProfile(userCredential.user, { displayName: name });
                    
                    // Create teacher document
                    await setDoc(doc(db, "teachers", userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        name: name,
                        email: email,
                        teacherCode: teacherCode,
                        createdAt: new Date(),
                        students: [], // Array of student IDs connected to this teacher
                        examsCreated: [], // Array of exam IDs created by this teacher
                        isActive: true
                    });
                    
                    Swal.fire({
                        title: 'Success!',
                        html: `
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-check text-blue-600 dark:text-blue-400 text-2xl"></i>
                                </div>
                                <p class="font-bold mb-2">Teacher Account Created!</p>
                                <p class="text-sm mb-2">Your Teacher Code:</p>
                                <div class="text-xl font-mono font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/50 p-2 rounded">
                                    ${teacherCode}
                                </div>
                                <p class="text-xs text-slate-500 mt-2">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Save this code! Students will use it to connect with you.
                                </p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'Continue to Dashboard',
                        confirmButtonColor: '#1d4ed8'
                    }).then(() => {
                        Auth.finalizeTeacher(userCredential.user);
                    });
                }
            } catch(e) {
                console.error("Teacher signup error:", e);
                let errorMessage = e.message.replace('Firebase: ', '');
                
                if (e.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already registered. Please use a different email or login.";
                } else if (e.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak. Please use a stronger password.";
                } else if (e.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format. Please check your email.";
                }
                
                Swal.fire('Registration Failed', errorMessage, 'error');
            }
        },
        
        teacherLogin: async () => {
            if(!auth || !db) {
                Swal.fire("System Error", "Database connection not available. Please refresh the page.", "error");
                return;
            }
            
            const btn = document.getElementById('t-login-btn');
            const email = document.getElementById('t-email').value.trim();
            const password = document.getElementById('t-pass').value;
            
            if(!email || !password) {
                Swal.fire('Required','Please enter both email and password','warning');
                return;
            }

            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div> Logging in...';
            btn.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Check if user is registered as teacher
                const teacherDoc = await getDoc(doc(db, "teachers", userCredential.user.uid));
                
                if (!teacherDoc.exists()) {
                    throw new Error("This email is not registered as a teacher. Please use teacher registration.");
                }
                
                const teacherData = teacherDoc.data();
                
                // Check if teacher account is active
                if (teacherData.isActive === false) {
                    throw new Error("This teacher account has been deactivated. Please contact support.");
                }
                
                console.log("Teacher login successful:", teacherData.email);
                Auth.finalizeTeacher(userCredential.user);
                
            } catch(e) {
                console.error("Teacher login error details:", e);
                let errorMessage = e.message.replace('Firebase: ', '');
                
                if (e.code === 'auth/user-not-found') {
                    errorMessage = "No teacher account found with this email. Please register first.";
                } else if (e.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect password. Please try again.";
                } else if (e.code === 'auth/too-many-requests') {
                    errorMessage = "Too many failed attempts. Please try again later.";
                } else if (e.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format. Please check your email.";
                }
                
                Swal.fire({
                    title: 'Login Failed',
                    text: errorMessage,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        },
        
        finalizeTeacher: (user) => {
            console.log("Finalizing teacher login");
            AppState.role = 'teacher';
            AppState.user = user;
            
            // Clear any previous listeners
            clearListeners();
            
            // Initialize teacher panel
            Router.initTeacher();
            
            // Show success message
            setTimeout(() => {
                Swal.fire({
                    title: 'Welcome Teacher!',
                    text: 'Access to Teacher Panel granted',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            }, 300);
        },
        
        confirmLogout: () => {
            Swal.fire({
                title: 'Logout?',
                text: "Are you sure you want to logout?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Logout',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                reverseButtons: true
            }).then((result) => {
                if(result.isConfirmed) {
                    Auth.logout();
                }
            });
        },
        
        logout: async () => {
            try {
                clearListeners();
                
                if(AppState.role === 'teacher') {
                    localStorage.removeItem('teacher_sess');
                    console.log("Teacher session cleared");
                } else {
                    if (auth.currentUser) {
                        await signOut(auth);
                        console.log("User signed out");
                    }
                }
                
                // Reset app state
                AppState.role = 'guest';
                AppState.user = null;
                AppState.isDemo = false;
                
                // Show logout message
                Swal.fire({
                    title: 'Logged Out',
                    text: 'You have been successfully logged out.',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
                
            } catch (error) {
                console.error("Logout error:", error);
                location.reload();
            }
        }
    };
    
    window.Auth = Auth;

    const Router = {
        initStudent: (userData) => {
            try {
                console.log("Initializing student panel for:", userData?.email);
                
                AppState.user = { 
                    ...auth.currentUser, 
                    ...userData 
                };
                
                // Hide auth screen, show app
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('flex');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('student-nav').classList.remove('hidden');
                document.getElementById('student-nav').classList.add('flex');
                
                // Initialize cache and load dashboard
                initGlobalCache();
                Student.loadDashboard();
                
                console.log("Student panel initialized successfully");
                
            } catch (error) {
                console.error("Error initializing student panel:", error);
                Swal.fire('Error', 'Failed to load student panel. Please try again.', 'error');
                Auth.logout();
            }
        },
        
        initTeacher: () => {
            try {
                console.log("Initializing teacher panel");
                
                // Hide auth screen, show app
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('flex');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('pt-16');
                document.getElementById('teacher-nav').classList.remove('hidden');
                document.getElementById('teacher-nav').classList.add('flex');
                document.getElementById('teacher-header').classList.remove('hidden');
                document.getElementById('teacher-header').classList.add('flex');
                
                // Initialize cache and load create view
                initGlobalCache();
                Teacher.createView();
                
                console.log("Teacher panel initialized successfully");
                
            } catch (error) {
                console.error("Error initializing teacher panel:", error);
                Swal.fire('Error', 'Failed to load teacher panel. Please try again.', 'error');
                Auth.logout();
            }
        },
        
        student: (p) => {
            if(AppState.user?.disabled && p !== 'dashboard' && p !== 'profile') {
                Swal.fire('Access Denied', 'Your account is disabled. Contact teacher.', 'warning');
                return;
            }
            
            clearListeners();
            
            // Update navigation
            document.querySelectorAll('#student-nav .nav-item').forEach(el => {
                el.classList.remove('text-indigo-600', 'active');
            });
            
            const navButton = document.querySelector(`#student-nav button[data-route="${p}"]`);
            if (navButton) {
                navButton.classList.add('text-indigo-600', 'active');
            }
            
            // Load the appropriate view
            switch(p) {
                case 'dashboard':
                    Student.loadDashboard();
                    break;
                case 'rank':
                    Student.loadRankings();
                    break;
                case 'results':
                    Student.loadResults();
                    break;
                case 'profile':
                    Student.profile();
                    break;
                default:
                    Student.loadDashboard();
            }
        },
        
        teacher: (p) => {
            clearListeners();
            
            // Update navigation
            document.querySelectorAll('#teacher-nav .nav-item').forEach(el => {
                el.classList.remove('text-blue-600', 'active');
            });
            
            const navButton = document.querySelector(`#teacher-nav button[data-route="${p}"]`);
            if (navButton) {
                navButton.classList.add('text-blue-600', 'active');
            }
            
            // Load the appropriate view
            switch(p) {
                case 'create':
                    Teacher.createView();
                    break;
                case 'rank':
                    Teacher.rankView();
                    break;
                case 'management':
                    Teacher.managementView();
                    break;
                case 'teacher-profile':
                    Teacher.profileView();
                    break;
                default:
                    Teacher.createView();
            }
        }
    };
    
    window.Router = Router;

    const Student = {
        loadDashboard: () => {
            let hasLive = Object.values(ExamCache).some(e => e.type === 'live' && !e.resultPublished && e.status === 'published');
            document.getElementById('app-container').innerHTML = `
            <div class="p-5 pb-20 max-w-lg mx-auto h-full flex flex-col justify-center animate-[fadeIn_0.5s]">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold font-bn text-slate-800 dark:text-white">Smart<span class="text-indigo-600 dark:text-indigo-400">Exam</span></h2>
                    <div class="w-10 h-10 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center border-2 border-white dark:border-slate-800 shadow">
                        <i class="fas fa-user text-slate-500"></i>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <button onclick="Student.loadLiveExams()" class="h-40 rounded-3xl bg-gradient-to-br from-violet-600 to-indigo-600 text-white p-6 relative overflow-hidden shadow-xl shadow-indigo-200 dark:shadow-none transition active:scale-95 flex flex-col justify-center items-center text-center group">
                        <div class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-sm mb-3">
                            <i class="fas fa-bolt text-xl"></i>
                        </div>
                        <div class="text-2xl font-bold">লাইভ এক্সাম</div>
                        <i class="fas fa-bolt absolute -right-4 -bottom-6 text-8xl opacity-10 rotate-12 group-hover:scale-110 transition"></i>
                        ${hasLive ? `
                            <div class="absolute top-4 right-4 flex items-center gap-2">
                                <span class="relative flex h-3 w-3">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 shadow-[0_0_15px_rgba(239,68,68,1)]"></span>
                                </span>
                                <span class="text-[10px] font-bold text-red-100 animate-pulse tracking-wider">LIVE</span>
                            </div>` : ''}
                    </button>
                    <button onclick="Student.loadMockHub()" class="h-40 rounded-3xl bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6 relative overflow-hidden shadow-xl shadow-emerald-200 dark:shadow-none transition active:scale-95 flex flex-col justify-center items-center text-center group">
                        <div class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-sm mb-3">
                            <i class="fas fa-book-open text-xl"></i>
                        </div>
                        <div class="text-2xl font-bold">অনুশীলন</div>
                        <i class="fas fa-pen-nib absolute -right-4 -bottom-6 text-8xl opacity-10 rotate-12 group-hover:scale-110 transition"></i>
                    </button>
                </div>
            </div>`;
        },
        loadLiveExams: async () => {
            if(AppState.user?.disabled) return Swal.fire('Access Denied', 'Your account is disabled. Contact teacher.', 'warning');
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            // Refresh cache if empty
            if (Object.keys(ExamCache).length === 0) {
                await refreshExamCache();
            }

            setTimeout(() => {
                let h = ''; 
                const now = new Date();
                Object.values(ExamCache).forEach(e => {
                    if(e.type === 'live' && e.status === 'published') {
                        const start = new Date(e.startTime);
                        const end = new Date(e.endTime);
                        let btn = '';
                        let btnClass = '';
                        
                        if(now < start) {
                            btn = `<button class="w-full bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 py-3 rounded-xl font-bold text-sm cursor-not-allowed animate-pulse">শুরু হবে: ${moment(start).format('h:mm A')}</button>`;
                        } else if(now > end) {
                            btn = `<button class="w-full bg-red-100 dark:bg-red-900/40 text-red-500 dark:text-red-400 py-3 rounded-xl font-bold text-sm cursor-not-allowed">সময় শেষ (Waiting)</button>`;
                        } else if(!e.resultPublished) {
                            btn = `<button onclick="Exam.start('${e.id}')" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl font-bold text-sm shadow hover:shadow-lg transform transition active:scale-[0.98] hover:scale-[1.02] animate-pulse">পরীক্ষা শুরু করুন</button>`;
                            btnClass = 'border-2 border-indigo-300 dark:border-indigo-700';
                        } else {
                            btn = `<button onclick="Student.viewResultFromExam('${e.id}')" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow">ফলাফল দেখুন</button>`;
                        }
                        
                        h += `
                            <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-4 animate-[fadeIn_0.5s] ${btnClass}">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-[10px] font-bold bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded uppercase flex items-center gap-1">
                                        <i class="fas fa-bolt"></i> LIVE
                                    </span>
                                    <span class="text-[10px] text-slate-400 font-bold">${e.duration}m</span>
                                </div>
                                <h3 class="font-bold text-lg mb-1">${e.title}</h3>
                                ${e.subject?`<div class="text-xs text-indigo-600 dark:text-indigo-400 font-bold mb-3">${e.subject} ${e.chapter?'• '+e.chapter:''}</div>`:''}
                                ${btn}
                            </div>`;
                    }
                });
                c.innerHTML = `
                    <div class="p-5 pb-20 animate-[slideIn_0.4s]">
                        <button onclick="Student.loadDashboard()" class="mb-4 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i> Dashboard
                        </button>
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-indigo-600 dark:text-indigo-400"></i>
                            </div>
                            লাইভ এক্সাম
                        </h2>
                        ${h || '<div class="text-center py-20 text-slate-400 animate-pulse">কোনো সক্রিয় পরীক্ষা নেই</div>'}
                    </div>`;
            }, 300);
        },
        loadMockHub: async () => {
            if(AppState.user?.disabled) return Swal.fire('Access Denied', 'Your account is disabled. Contact teacher.', 'warning');
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            // Refresh cache if empty
            if (Object.keys(ExamCache).length === 0) {
                await refreshExamCache();
            }

            setTimeout(() => {
                let subjectsMap = new Map();
                
                Object.values(ExamCache).forEach(e => { 
                    if(e.type === 'mock' && e.status === 'published') {
                        const subject = e.subject || "General";
                        const chapter = e.chapter || "Uncategorized";
                        
                        if (!subjectsMap.has(subject)) {
                            subjectsMap.set(subject, {
                                name: subject,
                                chapters: new Set(),
                                count: 0
                            });
                        }
                        
                        const subjectData = subjectsMap.get(subject);
                        subjectData.chapters.add(chapter);
                        subjectData.count++;
                    }
                });
                
                let html = '';
                if (subjectsMap.size === 0) {
                    html = `
                    <div class="text-center py-16 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl">
                        <i class="fas fa-book-open text-4xl text-slate-400 mb-4"></i>
                        <p class="text-slate-500 dark:text-slate-400">No practice exams available</p>
                        <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">Check back later for new content</p>
                    </div>`;
                } else {
                    html = `<div class="space-y-4">`;
                    subjectsMap.forEach((subjectData, subjectName) => {
                        html += `
                        <div class="bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 overflow-hidden">
                            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition"
                                 onclick="Student.toggleSubjectChapters('${subjectName.replace(/'/g, "\\'")}')">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 text-white flex items-center justify-center font-bold text-xl shadow-lg">
                                        ${subjectName[0]}
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-800 dark:text-slate-200">${subjectName}</h3>
                                        <p class="text-xs text-slate-500">${subjectData.count} exams • ${subjectData.chapters.size} chapters</p>
                                    </div>
                                </div>
                                <i id="chevron-${subjectName.replace(/\s+/g, '-')}" class="fas fa-chevron-down text-slate-400 transition-transform"></i>
                            </div>
                            
                            <div id="chapters-${subjectName.replace(/\s+/g, '-')}" class="hidden border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                                <div class="p-4">
                                    <div class="space-y-2">`;
                        
                        subjectData.chapters.forEach(chapter => {
                            html += `
                                    <div onclick="Student.loadMockExams('${subjectName.replace(/'/g, "\\'")}', '${chapter.replace(/'/g, "\\'")}')" 
                                         class="flex justify-between items-center p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg cursor-pointer hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:border-emerald-200 dark:hover:border-emerald-700 transition">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-file-alt text-emerald-500"></i>
                                            <span class="font-medium text-slate-700 dark:text-slate-300">${chapter}</span>
                                        </div>
                                        <i class="fas fa-chevron-right text-slate-400"></i>
                                    </div>`;
                        });
                        
                        html += `
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                }
                
                c.innerHTML = `
                    <div class="p-5 pb-20 animate-[slideIn_0.4s]">
                        <button onclick="Student.loadDashboard()" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-emerald-600 dark:hover:text-emerald-400 transition flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i> Dashboard
                        </button>
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book-open text-emerald-600 dark:text-emerald-400"></i>
                            </div>
                            অনুশীলন - বিষয় নির্বাচন করুন
                        </h2>
                        ${html}
                    </div>`;
            }, 300);
        },
        
        toggleSubjectChapters: (subjectName) => {
            const safeName = subjectName.replace(/\s+/g, '-');
            const chaptersDiv = document.getElementById(`chapters-${safeName}`);
            const chevron = document.getElementById(`chevron-${safeName}`);
            
            if (chaptersDiv.classList.contains('hidden')) {
                chaptersDiv.classList.remove('hidden');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                chaptersDiv.classList.add('hidden');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        },
        
        loadMockExams: (sub, chap) => {
            const exams = Object.values(ExamCache).filter(e => e.type === 'mock' && e.status === 'published' && (e.subject||"General")===sub && (e.chapter||"Mixed")===chap);
            const h = exams.map(e => `
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 mb-4">
                    <h3 class="font-bold text-lg mb-1">${e.title}</h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">Marks: ${e.totalMarks} • Time: ${e.duration}m</p>
                    <button onclick="Exam.start('${e.id}')" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow">Start Practice</button>
                </div>`).join('');
            document.getElementById('app-container').innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Student.loadMockHub()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                        <i class="fas fa-arrow-left"></i> Subjects
                    </button>
                    <h2 class="text-xl font-bold mb-1">${sub}</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${chap}</p>
                    ${h}
                </div>`;
        },
        loadRankings: () => {
            const c = document.getElementById('app-container');
            const exams = Object.values(ExamCache).filter(e => e.status === 'published').sort((a,b)=>b.createdAt-a.createdAt);
            let h = ''; 
            exams.forEach(e => { 
                if((e.type==='mock'||e.resultPublished) && e.status === 'published') {
                    h += `
                    <div onclick="Student.openRank('${e.id}','${e.title}')" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border dark:border-slate-700 mb-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <div>
                            <div class="font-bold text-sm">${e.title}</div>
                            <div class="text-xs text-slate-400 mt-1">
                                ${e.subject?e.subject+' • ':''}${moment(e.createdAt.toDate()).format('DD MMM')}
                            </div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 flex items-center justify-center">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                    </div>`;
                }
            });
            c.innerHTML = `
                <div class="p-5 pb-20">
                    <h2 class="text-2xl font-bold mb-4">মেরিট লিস্ট (Rank)</h2>
                    ${h || '<div class="text-center p-10 text-slate-400">Empty</div>'}
                </div>`;
        },
        openRank: (eid, title) => {
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            const unsub = onSnapshot(query(collection(db, "attempts"), where("examId", "==", eid), orderBy("score", "desc")), (snap) => {
                let rows = ''; 
                const uid = auth.currentUser?.uid; 
                let myRank = 'N/A';
                snap.docs.forEach((d,i)=>{
                    const a = d.data();
                    if(a.userId===uid) myRank = i+1;
                    let rowClass = AppState.role==='teacher' ? 'cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition' : '';
                    let clickAction = AppState.role==='teacher' ? `onclick="Teacher.viewUserAttempt('${d.id}','${eid}','${title}')"` : '';
                    rows += `
                    <div class="flex items-center p-3 border-b dark:border-slate-700 bg-white dark:bg-slate-800 ${a.userId===uid?'bg-indigo-50 dark:bg-indigo-900/50 border-l-4 border-indigo-500':''} ${rowClass}" ${clickAction}>
                        <div class="w-8 text-center font-bold text-slate-500 dark:text-slate-400">${i+1}</div>
                        <div class="flex-1 ml-3 font-bold text-sm truncate">${a.userName} ${a.userId===uid?'(You)':''}</div>
                        <div class="font-bold text-indigo-600 dark:text-indigo-400 text-sm">${a.score.toFixed(2)}</div>
                    </div>`;
                });
                const back = AppState.role === 'teacher' ? "Teacher.rankView()" : "Student.loadRankings()";
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="${back}" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <div class="bg-indigo-600 text-white rounded-xl p-4 mb-4 shadow">
                        <h3 class="font-bold text-lg">${title}</h3>
                        <div class="flex justify-between mt-2 text-xs">
                            <p>Participants: ${snap.size}</p>
                            ${myRank!=='N/A'?'<p>My Rank: '+myRank+'</p>':''}
                        </div>
                    </div>
                    <div class="rounded-xl border dark:border-slate-700 shadow-sm bg-white dark:bg-slate-800 overflow-hidden">
                        ${rows || '<div class="p-4 text-center">No Data</div>'}
                    </div>
                </div>`;
            }); 
            unsubscribes.push(unsub);
        },
        loadResults: () => {
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            const unsub = onSnapshot(query(collection(db, "attempts"), where("userId", "==", auth.currentUser.uid), orderBy("submittedAt", "desc")), (snap) => {
                let h = ''; 
                snap.forEach(d => { 
                    const a = d.data(); 
                    const e = ExamCache[a.examId]; 
                    if(!e) return;
                    const isPub = (e.type==='mock'||e.resultPublished) && e.status === 'published'; 
                    h += `
                    <div class="bg-white dark:bg-slate-800 p-4 mb-3 rounded-2xl border dark:border-slate-700 shadow-sm">
                        <div class="flex justify-between">
                            <div>
                                <div class="font-bold text-sm">${a.examTitle}</div>
                                <div class="text-xs text-slate-400">${moment(a.submittedAt.toDate()).format('DD MMM, h:mm A')}</div>
                            </div>
                            <div class="font-bold text-xl">${isPub?a.score.toFixed(2):'<i class="fas fa-lock text-slate-500"></i>'}</div>
                        </div>
                        ${isPub?`
                        <div class="flex gap-2 mt-3 pt-2 border-t dark:border-slate-700">
                            <button onclick="Student.viewResult('${d.id}')" class="flex-1 text-xs font-bold py-2 bg-emerald-50 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-400 rounded">View Solution</button>
                            <button onclick="Exam.start('${a.examId}')" class="flex-1 text-xs font-bold py-2 bg-indigo-50 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-400 rounded">Retake Exam</button>
                        </div>`:''}
                    </div>`; 
                });
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <h2 class="text-2xl font-bold mb-4">ফলাফল ও বিশ্লেষণ</h2>
                    ${h || '<div class="text-center p-10 text-slate-400">Empty</div>'}
                </div>`;
            }); 
            unsubscribes.push(unsub);
        },
        viewResult: async (id, backContext=null) => {
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            const attSnap = await getDoc(doc(db, "attempts", id));
            if(!attSnap.exists()) return; 
            const att = attSnap.data();
            const exam = ExamCache[att.examId];
            if(!exam) { 
                c.innerHTML = '<div class="p-10 text-center">Exam Deleted</div>'; 
                return; 
            }
            const qs = JSON.parse(exam.questions);
            let h = qs.map((q,i) => {
                const u = att.answers[i]; 
                let st='skipped', badge='Skipped';
                if(u===q.correct){st='correct';badge='Correct';}else if(u!==null){st='wrong';badge='Wrong';}
                return `
                <div class="ans-card ${st} p-4 rounded-xl mb-4 bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-sm">
                    <div class="flex justify-between mb-2 pb-2 border-b border-black/5 dark:border-white/10">
                        <span class="font-bold text-sm">Q${i+1}</span>
                        <span class="text-xs font-bold">${badge}</span>
                    </div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 mb-2">
                        ${q.year ? `<span class="bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-400 px-2 py-1 rounded mr-2"><i class="fas fa-calendar-alt mr-1"></i>${q.year}</span>` : ''}
                    </div>
                    <div class="text-sm font-semibold mb-3">${q.q}</div>
                    <div class="space-y-1">
                        ${q.options.map((o,oi)=>`
                            <div class="opt-res dark:border-slate-600 dark:text-slate-300 ${oi===q.correct?'right':(oi===u?'wrong-select':'')}">
                                <span>${String.fromCharCode(65+oi)}. ${o}</span>
                            </div>`).join('')}
                    </div>
                    <div class="mt-3 text-xs bg-white/60 dark:bg-slate-900/50 p-3 rounded border dark:border-slate-700">
                        <b>Expl:</b> ${q.expl}
                    </div>
                </div>`;
            }).join('');
            let backAction = "Router.student('results')";
            let title = "বিস্তারিত সমাধান";
            if(backContext) {
                backAction = `Student.openRank('${backContext.examId}','${backContext.examTitle}')`;
                title = `${att.userName}'s Answer Script`;
            }
            c.innerHTML = `
            <div class="p-5 pb-24">
                <button onclick="${backAction}" class="mb-4 text-xs font-bold text-slate-500">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h2 class="font-bold text-xl mb-4">${title}</h2>
                ${h}
            </div>`;
            MathJax.typesetPromise();
        },
        profile: () => { 
            const u = auth.currentUser;
            document.getElementById('app-container').innerHTML = `
            <div class="p-10 text-center">
                <div class="w-20 h-20 bg-indigo-600 rounded-full mx-auto text-white flex items-center justify-center text-3xl font-bold mb-4 shadow-lg border-4 border-white dark:border-slate-800">
                    ${u.displayName?u.displayName[0]:'U'}
                </div>
                <h2 class="text-xl font-bold">${u.displayName}</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">${u.email}</p>
                ${AppState.user?.teacherName ? `
                <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-700">
                    <p class="text-xs text-blue-700 dark:text-blue-300">Connected Teacher:</p>
                    <p class="font-bold text-blue-800 dark:text-blue-200">${AppState.user.teacherName}</p>
                </div>` : ''}
                <button id="theme-toggle-btn-user" class="mt-8 bg-white dark:bg-slate-700 w-full py-3 rounded-xl font-bold hover:bg-slate-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-moon"></i> Switch Theme
                </button>
                ${!AppState.isDemo ? `
                <button id="profile-logout-btn" class="mt-4 bg-red-50 dark:bg-red-900/50 text-red-600 dark:text-red-400 w-full py-3 rounded-xl font-bold hover:bg-red-100 dark:hover:bg-red-900 transition">
                    Logout
                </button>`:''}
            </div>`;
            const themeBtn = document.getElementById('theme-toggle-btn-user');
            if (themeBtn) {
                themeBtn.addEventListener('click', Theme.toggle);
            }
            if(!AppState.isDemo) {
                const logoutBtn = document.getElementById('profile-logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', Auth.confirmLogout);
                }
            }
            Theme.updateIcon();
        }
    };
    window.Student = Student;

    const Exam = {
        d: null, 
        ans: [], 
        t: null,
        start: async (id) => {
            const e = ExamCache[id]; 
            if(!e) return Swal.fire('Error','Not Found','error');
            if(AppState.user?.disabled) return Swal.fire('Access Denied', 'Your account is disabled. Contact teacher.', 'warning');
            if(!AppState.isDemo && e.type === 'live') { 
                const now = new Date(); 
                if(now < new Date(e.startTime)) return Swal.fire('Wait','Not started','info'); 
                if(now > new Date(e.endTime) && !e.resultPublished) return Swal.fire('Closed','Time Over','warning'); 
                const attempts = await getDocs(query(collection(db,"attempts"),where("userId","==",auth.currentUser.uid),where("examId","==",id))); 
                if(!e.resultPublished && !attempts.empty) return Swal.fire('Done','You have already taken this exam.','warning'); 
            }
            document.getElementById('student-nav').classList.add('hidden'); 
            document.getElementById('demo-exit-btn').classList.add('hidden');
            Exam.d = { ...e, qs: JSON.parse(e.questions) }; 
            Exam.ans = new Array(Exam.d.qs.length).fill(null);
            Exam.render(); 
            Exam.runT(Exam.d.duration*60);
        },
        render: () => {
            const h = Exam.d.qs.map((q,i) => `
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border dark:border-slate-700 mb-4" id="q-${i}">
                <div class="font-bold mb-3">
                    <span class="bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 px-2 text-sm mr-2 rounded">${i+1}</span>
                    ${q.q}
                </div>
                <div class="space-y-2">
                    ${q.options.map((o,oi)=>`
                    <button onclick="Exam.sel(${i},${oi})" id="b-${i}-${oi}" class="opt-btn w-full text-left p-3 rounded-lg border dark:border-slate-600 text-sm flex gap-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition text-slate-600 dark:text-slate-300 border-slate-200">
                        <span class="font-bold opacity-50 w-6">${String.fromCharCode(65+oi)}.</span>
                        <div>${o}</div>
                    </button>`).join('')}
                </div>
            </div>`).join('');
            const navCircles = Exam.d.qs.map((_,i) => `
            <button id="nav-q-${i}" onclick="Exam.jumpTo(${i})" class="w-8 h-8 rounded-full border dark:border-slate-600 flex items-center justify-center font-mono text-xs font-bold">
                ${i+1}
            </button>`).join('');
            document.getElementById('app-container').innerHTML = `
            <div class="sticky top-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur border-b dark:border-slate-700 px-4 py-3 flex justify-between items-center z-30 shadow-md">
                <div>
                    <span class="font-bold block text-sm truncate w-32">${Exam.d.title}</span>
                    <span id="tm" class="text-xs font-mono bg-slate-100 dark:bg-slate-700 px-1 rounded text-slate-600 dark:text-slate-300">00:00</span>
                </div>
                <button onclick="Exam.sub()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition">
                    SUBMIT
                </button>
            </div>
            <div class="p-4 pb-20 select-none">${h}</div>
            <div class="fixed bottom-5 right-5 z-50">
                <button id="q-nav-toggle-btn" class="w-12 h-12 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center">
                    <i class="fas fa-list-ol"></i>
                </button>
                <div id="q-nav-panel" class="hidden absolute bottom-14 right-0 w-64 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-2xl p-4 max-h-64 overflow-y-auto">
                    <div class="grid grid-cols-5 gap-2">${navCircles}</div>
                </div>
            </div>`;
            const toggleBtn = document.getElementById('q-nav-toggle-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const panel = document.getElementById('q-nav-panel');
                    panel.classList.toggle('hidden');
                });
            }
            MathJax.typesetPromise();
        },
        sel: (qi, oi) => {
            Exam.ans[qi] = oi;
            document.querySelectorAll(`#q-${qi} .opt-btn`).forEach((b, index) => {
                b.classList.remove('selected');
                if(index === oi) b.classList.add('selected');
            });
            const navBtn = document.getElementById(`nav-q-${qi}`);
            if (navBtn) {
                navBtn.classList.add('bg-green-500', 'text-white', 'border-green-500');
            }
        },
        jumpTo: (qi) => {
            const element = document.getElementById(`q-${qi}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            const panel = document.getElementById('q-nav-panel');
            if (panel) {
                panel.classList.add('hidden');
            }
        },
        runT: (sec) => { 
            clearInterval(Exam.t); 
            Exam.t = setInterval(()=>{ 
                sec--; 
                const tmEl = document.getElementById('tm'); 
                if (tmEl) {
                    const minutes = Math.floor(sec/60).toString().padStart(2,'0');
                    const seconds = (sec%60).toString().padStart(2,'0');
                    tmEl.innerText = `${minutes}:${seconds}`;
                }
                if(sec<=0) { 
                    clearInterval(Exam.t); 
                    Exam.sub(true); 
                } 
            },1000); 
        },
        sub: async (auto=false) => {
            if(!auto) { 
                const res = await Swal.fire({
                    title:'Submit Exam?', 
                    icon:'question', 
                    showCancelButton:true, 
                    confirmButtonText:'Yes, Submit'
                }); 
                if (!res.isConfirmed) return; 
            }
            clearInterval(Exam.t);
            let score = 0; 
            Exam.d.qs.forEach((q,i) => { 
                if(Exam.ans[i]==q.correct) {
                    score++; 
                } else if(Exam.ans[i]!==null && Exam.ans[i] !== undefined) {
                    score -= (Exam.d.negativeMark||0); 
                }
            }); 
            score = Math.max(0, score);
            if(!AppState.isDemo) {
                await addDoc(collection(db, "attempts"), { 
                    userId: auth.currentUser.uid, 
                    userName: auth.currentUser.displayName, 
                    examId: Exam.d.id, 
                    examTitle: Exam.d.title, 
                    score, 
                    answers: Exam.ans, 
                    submittedAt: new Date() 
                });
            }
            const showInstant = Exam.d.type === 'mock' || Exam.d.resultPublished || AppState.isDemo;
            Swal.fire(
                showInstant?'Result':'Submitted', 
                showInstant?`Score: ${score.toFixed(2)}`:'Wait for result.', 
                'success'
            ).then(() => { 
                if(AppState.isDemo) {
                    Teacher.exitDemo(); 
                } else {
                    Router.student(showInstant?'results':'dashboard'); 
                }
            });
            document.getElementById('student-nav').classList.remove('hidden');
        }
    };
    window.Exam = Exam;

    const Teacher = {
        createView: () => {
            document.getElementById('app-container').innerHTML = `
            <div class="p-5 max-w-2xl mx-auto pb-20">
                <h2 class="text-xl font-bold mb-6 font-en">Create Exam</h2>
                <div class="grid grid-cols-1 gap-4">
                    <button onclick="Teacher.renderForm('live')" class="h-36 rounded-2xl bg-gradient-to-r from-violet-600 to-indigo-600 text-white p-6 shadow-lg text-left relative overflow-hidden">
                        <i class="fas fa-bolt text-3xl mb-2 opacity-80"></i>
                        <h3 class="text-2xl font-bold">Create Live Exam</h3>
                        <p class="text-indigo-100 text-xs">Schedule exams.</p>
                    </button>
                    <button onclick="Teacher.renderForm('mock')" class="h-36 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-6 shadow-lg text-left relative overflow-hidden">
                        <i class="fas fa-book-open text-3xl mb-2 opacity-80"></i>
                        <h3 class="text-2xl font-bold">Create Practice</h3>
                        <p class="text-emerald-100 text-xs">Organize in folders.</p>
                    </button>
                </div>
            </div>`;
        },
        
        renderForm: async (type, editId = null) => {
            let existing = null;
            let tempQuestions = [];
            if (editId) { 
                existing = ExamCache[editId]; 
                type = existing.type; 
                if (existing.questions) tempQuestions = JSON.parse(existing.questions); 
            }

            window.lastFormType = type; 
            window.lastFormId = editId;

            const catSnap = await getDocs(query(collection(db, "categories"), orderBy("name")));
            let catOpts = '<option value="">Select Subject</option>';
            const cats = [];
            catSnap.forEach(d => { 
                const c = d.data(); 
                cats.push({ id: d.id, ...c }); 
                catOpts += `<option value="${c.name}">${c.name}</option>`; 
            });
            catOpts += '<option value="__new_subject__" class="font-bold text-blue-600 dark:text-blue-400 p-2">+ Create New Subject</option>';

            // ছবি আপলোড বাটন ফাংশন
            const imageUploadButtons = (fieldId, label) => `
            <div class="mt-2">
                <label class="question-label">${label}</label>
                <div class="flex gap-2">
                    <input type="file" id="${fieldId}-image" accept="image/*" class="hidden" onchange="Teacher.handleImageUpload('${fieldId}', this)">
                    <button type="button" onclick="document.getElementById('${fieldId}-image').click()" class="flex-1 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-2 rounded-lg border border-blue-200 dark:border-blue-700 hover:bg-blue-100 dark:hover:bg-blue-800/50 transition">
                        <i class="fas fa-image mr-1"></i> Insert Image
                    </button>
                    <button type="button" onclick="Teacher.insertImagePlaceholder('${fieldId}')" class="flex-1 text-xs bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 px-3 py-2 rounded-lg border border-purple-200 dark:border-purple-700 hover:bg-purple-100 dark:hover:bg-purple-800/50 transition">
                        <i class="fas fa-code mr-1"></i> Add Placeholder
                    </button>
                </div>
                <div id="${fieldId}-image-preview" class="mt-2 hidden"></div>
            </div>`;

            // Enhanced Math Toolbar with Calculus Symbols
            const mathToolbarButtons = (fieldId) => `
                <div class="math-toolbar-toggle mb-2">
                    <button type="button" onclick="window.MathHelper.toggleMathToolbar('${fieldId}')" class="toggle-math-toolbar bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs font-bold py-2 px-3 rounded-lg inline-flex items-center transition-all duration-200">
                        <i class="fas fa-calculator mr-2"></i> 
                        <span>গাণিতিক চিহ্ন টুলবার</span>
                        <i class="fas fa-chevron-down ml-2 text-xs"></i>
                    </button>
                </div>
                <div id="math-toolbar-${fieldId}" class="math-toolbar mb-4 p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 hidden">
                    <!-- Basic Operations -->
                    <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\frac', '{}{}')" title="ভগ্নাংশ" class="math-char-btn">a/b</button>
                    <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '^', '{}')" title="ঘাত" class="math-char-btn">x²</button>
                    <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '_', '{}')" title="সূচক" class="math-char-btn">x₁</button>
                    <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\sqrt', '{}')" title="বর্গমূল" class="math-char-btn">√</button>
                    <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\sqrt[n]{}')" title="nth রুট" class="math-char-btn">ⁿ√</button>
                    
                    <!-- Greek Letters Dropdown -->
                    <div class="math-dropdown">
                        <button type="button" class="math-dropdown-btn" title="গ্রীক অক্ষর">αβ</button>
                        <div class="math-dropdown-content">
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\alpha', '')">α</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\beta', '')">β</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\gamma', '')">γ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\delta', '')">δ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\epsilon', '')">ε</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\theta', '')">θ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\lambda', '')">λ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\mu', '')">μ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\pi', '')">π</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\sigma', '')">σ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\phi', '')">φ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\omega', '')">ω</button>
                        </div>
                    </div>
                    
                    <!-- Calculus Dropdown -->
                    <div class="math-dropdown">
                        <button type="button" class="math-dropdown-btn" title="ক্যালকুলাস">∫∑</button>
                        <div class="math-dropdown-content">
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\int', '')">∫</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\sum', '')">∑</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\prod', '')">∏</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\lim', '')">lim</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\infty', '')">∞</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\partial', '')">∂</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\nabla', '')">∇</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\Delta', '')">Δ</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\frac{d}{dx}', '')">d/dx</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\frac{\\\\partial}{\\\\partial x}', '')">∂/∂x</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\int_a^b', '')">∫<sub>a</sub><sup>b</sup></button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\oint', '')">∮</button>
                        </div>
                    </div>
                    
                    <!-- Operators Dropdown -->
                    <div class="math-dropdown">
                        <button type="button" class="math-dropdown-btn" title="অপারেটর">±×</button>
                        <div class="math-dropdown-content">
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\pm', '')">±</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\mp', '')">∓</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\times', '')">×</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\div', '')">÷</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\cdot', '')">·</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\circ', '')">∘</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\ast', '')">∗</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\star', '')">⋆</button>
                        </div>
                    </div>
                    
                    <!-- Relations Dropdown -->
                    <div class="math-dropdown">
                        <button type="button" class="math-dropdown-btn" title="সম্পর্ক">=≠</button>
                        <div class="math-dropdown-content">
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '=', '')">=</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\neq', '')">≠</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\equiv', '')">≡</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\approx', '')">≈</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\sim', '')">∼</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\propto', '')">∝</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\leq', '')">≤</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\geq', '')">≥</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\ll', '')">≪</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\gg', '')">≫</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\in', '')">∈</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\notin', '')">∉</button>
                        </div>
                    </div>
                    
                    <!-- Arrows & Vectors Dropdown -->
                    <div class="math-dropdown">
                        <button type="button" class="math-dropdown-btn" title="তীরচিহ্ন ও ভেক্টর">→</button>
                        <div class="math-dropdown-content">
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\vec', '{x}')">$\vec{x}$ ভেক্টর</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\overrightarrow{AB}', '')">$\overrightarrow{AB}$ একমুখী</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\overleftarrow{AB}', '')">$\overleftarrow{AB}$ বিপরীত</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\overleftrightarrow{AB}', '')">$\overleftrightarrow{AB}$ উভয়মুখী</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\rightarrow', '')">→ ডানদিক</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\leftarrow', '')">← বামদিক</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\uparrow', '')">↑ উপরে</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\downarrow', '')">↓ নিচে</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\leftrightarrow', '')">↔ উভয়দিক</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\Rightarrow', '')">⇒ ডানদিক (বড়)</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\Leftarrow', '')">⇐ বামদিক (বড়)</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\Leftrightarrow', '')">⇔ উভয়দিক (বড়)</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\mapsto', '')">↦ ম্যাপ টু</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\to', '')">→ টু</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\hat{x}', '')">$\hat{x}$ হ্যাট</button>
                            <button type="button" onclick="MathHelper.insertMathSymbol('${fieldId}', '\\\\bar{x}', '')">$\bar{x}$ বার</button>
                        </div>
                    </div>
                    
                    <!-- Help Button -->
                    <button type="button" onclick="MathHelper.showMathHelp('${fieldId}')" title="সাহায্য" class="text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/50">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            `;

            document.getElementById('app-container').innerHTML = `
            <div class="p-5 max-w-4xl mx-auto pb-20">
                <button onclick="${editId ? 'Teacher.historyView()' : 'Teacher.createView()'}" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border dark:border-slate-700 space-y-6">
                    <h2 class="text-2xl font-bold font-en">${editId ? 'Edit' : 'Create'} ${type} Exam</h2>
                    
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <div>
                            <label class="question-label">Exam Title</label>
                            <input id="nt" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter exam title" value="${existing ? existing.title : ''}">
                        </div>
                        <input type="hidden" id="nty" value="${type}">
                        <input type="hidden" id="eid" value="${editId || ''}">
                        
                        <div class="p-4 bg-slate-50 dark:bg-slate-900/50 rounded-xl border dark:border-slate-700">
                            <label class="question-label">CATEGORY (Optional for Live)</label>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <select id="nsub" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" onchange="Teacher.handleSubjectSelection(this.value)">
                                        ${catOpts}
                                    </select>
                                </div>
                                <div>
                                    <select id="nchap" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" onchange="Teacher.handleChapterSelection(this.value)">
                                        <option value="">Select Chapter</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="question-label">Duration (Minutes)</label>
                                <input id="nd" type="number" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" placeholder="Duration" value="${existing ? existing.duration : ''}">
                            </div>
                            <div>
                                <label class="question-label">Total Marks</label>
                                <input id="nm" type="number" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" placeholder="Marks" value="${existing ? existing.totalMarks : ''}">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="question-label">Negative Marking</label>
                                <select id="nneg" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200">
                                    <option value="0" ${existing && existing.negativeMark === 0 ? 'selected' : ''}>No Negative Marking</option>
                                    <option value="0.25" ${existing && existing.negativeMark === 0.25 ? 'selected' : ''}>0.25 per wrong answer</option>
                                    <option value="0.5" ${existing && existing.negativeMark === 0.5 ? 'selected' : ''}>0.50 per wrong answer</option>
                                </select>
                            </div>
                            <div>
                                <label class="question-label">Exam Type</label>
                                <div class="flex items-center justify-center text-sm font-bold bg-slate-100 dark:bg-slate-700 p-4 rounded-xl border dark:border-slate-600">
                                    ${type.toUpperCase()}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${type === 'live' ? `
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl border border-blue-100 dark:border-blue-800/50 space-y-4">
                        <div>
                            <label class="question-label text-blue-800 dark:text-blue-300">Start Time</label>
                            <input id="nst" type="datetime-local" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" value="${existing ? existing.startTime : ''}">
                        </div>
                        <div>
                            <label class="question-label text-blue-800 dark:text-blue-300">End Time</label>
                            <input id="net" type="datetime-local" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" value="${existing ? existing.endTime : ''}">
                        </div>
                    </div>` : ''}
                    
                    <!-- Questions Section -->
                    <div class="border-t dark:border-slate-700 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">Questions (<span id="q-count">${tempQuestions.length}</span>)</h3>
                            <button id="mode-toggle-btn" onclick="Teacher.toggleQuestionMode()" class="text-sm font-bold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">
                                Switch to JSON Mode
                            </button>
                        </div>
                        
                        <div id="manual-mode">
                            <!-- Question Input Form -->
                            <div class="question-input-container">
                                <input type="hidden" id="q-edit-index" value="-1">
                                
                                <div class="mb-6">
                                    <label class="question-label">Question</label>
                                    ${imageUploadButtons('q-text', 'Question Image')}
                                    <div class="math-editor-container" data-field-id="q-text">
                                        ${mathToolbarButtons('q-text')}
                                        <span id="q-text" class="math-editor-field"></span>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="question-label">Option A</label>
                                        <div class="math-editor-container" data-field-id="q-opt-0">
                                            ${mathToolbarButtons('q-opt-0')}
                                            <span id="q-opt-0" class="math-editor-field"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="question-label">Option B</label>
                                        <div class="math-editor-container" data-field-id="q-opt-1">
                                            ${mathToolbarButtons('q-opt-1')}
                                            <span id="q-opt-1" class="math-editor-field"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="question-label">Option C</label>
                                        <div class="math-editor-container" data-field-id="q-opt-2">
                                            ${mathToolbarButtons('q-opt-2')}
                                            <span id="q-opt-2" class="math-editor-field"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="question-label">Option D</label>
                                        <div class="math-editor-container" data-field-id="q-opt-3">
                                            ${mathToolbarButtons('q-opt-3')}
                                            <span id="q-opt-3" class="math-editor-field"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="question-label">Correct Answer</label>
                                        <select id="q-correct" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200">
                                            <option value="0">A</option>
                                            <option value="1">B</option>
                                            <option value="2">C</option>
                                            <option value="3">D</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="question-label">Previous Year (Optional)</label>
                                        <input type="text" id="q-year" class="w-full p-4 border dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" placeholder="e.g., 2023, HSC">
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="question-label">Explanation</label>
                                    ${imageUploadButtons('q-expl', 'Explanation Image')}
                                    <div class="math-editor-container" data-field-id="q-expl">
                                        ${mathToolbarButtons('q-expl')}
                                        <span id="q-expl" class="math-editor-field"></span>
                                    </div>
                                </div>
                                
                                <button id="add-q-btn" onclick="Teacher.addQuestion()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition active:scale-[0.98]">
                                    Add Question
                                </button>
                            </div>
                            
                            <!-- Questions List -->
                            <div class="mt-6">
                                <h4 class="font-bold mb-3">Added Questions</h4>
                                <div id="q-list" class="space-y-3"></div>
                            </div>
                        </div>
                        
                        <div id="json-mode" class="hidden">
                            <label class="question-label">JSON Questions</label>
                            <textarea id="nq" class="w-full h-80 p-4 border dark:border-slate-600 rounded-xl font-mono text-sm bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200" placeholder='Paste JSON Question Array here...'></textarea>
                            <p class="text-xs text-slate-500 mt-2">Format: [{"q": "question", "options": ["A", "B", "C", "D"], "correct": 0, "expl": "explanation", "year": "2023"}]</p>
                        </div>
                    </div>
                    
                    <button onclick="Teacher.saveExam('draft')" class="w-full bg-slate-600 hover:bg-slate-700 text-white py-5 rounded-xl font-bold text-lg shadow-lg transition active:scale-[0.98] mb-3">
                        Save as Draft
                    </button>
                    <button onclick="Teacher.saveExam('published')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-5 rounded-xl font-bold text-lg shadow-lg transition active:scale-[0.98]">
                        ${editId ? 'Update Exam' : 'Publish Exam'}
                    </button>
                </div>
            </div>`;

            window.tempCats = cats;
            window.tempQuestions = tempQuestions;
            Teacher.initMathEditors();
            Teacher.renderQuestionList();
            if (existing) {
                document.getElementById('nsub').value = existing.subject;
                Teacher.popChap(existing.subject, existing.chapter);
                document.getElementById('nneg').value = existing.negativeMark || "0";
            }
            
            // Initialize math dropdowns
            setTimeout(() => {
                window.MathHelper.setupMathDropdowns();
            }, 100);
        },
        
        // ছবি আপলোড হ্যান্ডলার
        handleImageUpload: async (fieldId, fileInput) => {
            const file = fileInput.files[0];
            if (!file) return;
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                Swal.fire('Error', 'Image size should be less than 2MB', 'error');
                return;
            }
            
            // Show loading
            Swal.fire({
                title: 'Uploading Image...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            try {
                // In a real app, you would upload to Firebase Storage
                // For demo, we'll create a data URL
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageUrl = e.target.result;
                    
                    // Insert image placeholder in the textarea
                    const textarea = document.getElementById(`${fieldId}-textarea`);
                    if (textarea) {
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos);
                        const textAfter = textarea.value.substring(cursorPos);
                        textarea.value = textBefore + `[img:${Date.now()}]` + textAfter;
                        
                        // Update MathQuill field
                        const mathField = window.mathFields?.[fieldId];
                        if (mathField) {
                            mathField.latex(textarea.value);
                        }
                        
                        // Show preview
                        const preview = document.getElementById(`${fieldId}-image-preview`);
                        preview.innerHTML = `
                            <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-green-700 dark:text-green-300">Image Added</span>
                                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/50 rounded flex items-center justify-center">
                                        <i class="fas fa-image text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <div class="text-xs">
                                        <div class="font-medium truncate">${file.name}</div>
                                        <div class="text-gray-500">${(file.size / 1024).toFixed(1)} KB</div>
                                    </div>
                                </div>
                            </div>`;
                        preview.classList.remove('hidden');
                    }
                    
                    Swal.close();
                };
                reader.readAsDataURL(file);
            } catch (error) {
                Swal.fire('Error', 'Failed to upload image: ' + error.message, 'error');
            }
        },

        // ইমেজ প্লেসহোল্ডার ইনসার্ট করা
        insertImagePlaceholder: (fieldId) => {
            const textarea = document.getElementById(`${fieldId}-textarea`);
            if (textarea) {
                const cursorPos = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPos);
                const textAfter = textarea.value.substring(cursorPos);
                textarea.value = textBefore + '[img:placeholder]' + textAfter;
                
                const mathField = window.mathFields?.[fieldId];
                if (mathField) {
                    mathField.latex(textarea.value);
                }
            }
        },
        
        // Enhanced MathQuill Initialization with Textarea Toggle
        initMathEditors: () => {
            window.mathFields = {};
            const MQ = MathQuill.getInterface(2);
            const fields = ['q-text', 'q-opt-0', 'q-opt-1', 'q-opt-2', 'q-opt-3', 'q-expl'];
            
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    // Clear any existing content
                    el.innerHTML = '';
                    
                    // Create a textarea for normal text input
                    const textarea = document.createElement('textarea');
                    textarea.id = id + '-textarea';
                    textarea.className = 'w-full h-32 p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 font-sans mb-2';
                    textarea.placeholder = '';
                    textarea.style.display = 'block';
                    textarea.spellcheck = false;
                    
                    // Insert textarea before the math field
                    el.parentElement.insertBefore(textarea, el);
                    
                    // Create MathQuill field
                    const mathField = MQ.MathField(el, {
                        spaceBehavesLikeTab: true,
                        restrictMismatchedBrackets: true,
                        supSubsRequireOperand: true,
                        handlers: {
                            edit: function() {
                                const latex = mathField.latex();
                                // Update textarea only if it's not focused (prevent interference)
                                if (document.activeElement !== textarea) {
                                    textarea.value = latex;
                                }
                            }
                        }
                    });
                    
                    window.mathFields[id] = mathField;
                    
                    // Initially hide the math field, show textarea
                    el.style.display = 'none';
                    
                    // Improved textarea event handling
                    let textareaChanged = false;
                    
                    textarea.addEventListener('input', function(e) {
                        textareaChanged = true;
                        // Allow normal typing including spaces
                        const cursorPos = this.selectionStart;
                        const value = this.value;
                        
                        // Update MathQuill field
                        setTimeout(() => {
                            mathField.latex(value);
                            // Restore cursor position
                            textarea.setSelectionRange(cursorPos, cursorPos);
                        }, 10);
                    });
                    
                    textarea.addEventListener('keydown', function(e) {
                        // Allow all normal keys including space, backspace, delete
                        if (e.key === ' ') {
                            // Allow space, don't prevent default
                        } else if (e.key === 'Backspace' || e.key === 'Delete') {
                            // Allow delete/backspace
                        } else if (e.key === 'Enter') {
                            // Allow enter
                        }
                    });
                    
                    // Add toggle button
                    const toggleBtn = document.createElement('button');
                    toggleBtn.type = 'button';
                    toggleBtn.innerHTML = '<i class="fas fa-square-root-alt"></i>';
                    toggleBtn.className = 'absolute right-2 top-2 text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 p-2 rounded-lg z-10 hover:bg-blue-200 dark:hover:bg-blue-800 transition';
                    toggleBtn.title = 'Toggle Math Mode';
                    toggleBtn.onclick = function() {
                        if(textarea.style.display === 'none') {
                            // Switching to text mode from math mode
                            textarea.value = mathField.latex();
                            textarea.style.display = 'block';
                            el.style.display = 'none';
                            toggleBtn.innerHTML = '<i class="fas fa-square-root-alt"></i>';
                            toggleBtn.title = 'Switch to Math Mode';
                            toggleBtn.classList.remove('bg-blue-600', 'text-white');
                            toggleBtn.classList.add('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-400');
                            textarea.focus();
                        } else {
                            // Switching to math mode from text mode
                            mathField.latex(textarea.value);
                            textarea.style.display = 'none';
                            el.style.display = 'block';
                            toggleBtn.innerHTML = '<i class="fas fa-font"></i>';
                            toggleBtn.title = 'Switch to Text Mode';
                            toggleBtn.classList.add('bg-blue-600', 'text-white');
                            toggleBtn.classList.remove('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-400');
                            mathField.focus();
                        }
                    };
                    
                    const container = el.parentElement;
                    container.style.position = 'relative';
                    container.appendChild(toggleBtn);
                }
            });
            
            // Set up the math dropdowns for the toolbars
            MathHelper.setupMathDropdowns();
        },

        toggleQuestionMode: () => {
            const manual = document.getElementById('manual-mode');
            const json = document.getElementById('json-mode');
            const btn = document.getElementById('mode-toggle-btn');
            if(manual.classList.contains('hidden')) {
                manual.classList.remove('hidden'); 
                json.classList.add('hidden');
                btn.innerText = 'Switch to JSON Mode';
                try { 
                    const questionsFromJSON = JSON.parse(document.getElementById('nq').value || '[]');
                    if(Array.isArray(questionsFromJSON)) {
                         window.tempQuestions = questionsFromJSON;
                    } else {
                        throw new Error("Invalid format. Must be an array.");
                    }
                } catch(e){ 
                    Swal.fire('JSON Error', e.message, 'error');
                }
                Teacher.renderQuestionList();
            } else {
                manual.classList.add('hidden'); 
                json.classList.remove('hidden');
                btn.innerText = 'Switch to Manual Mode';
                document.getElementById('nq').value = JSON.stringify(window.tempQuestions, null, 2);
            }
        },
        
        addQuestion: () => {
            // Get values from textareas
            const q = {
                q: document.getElementById('q-text-textarea')?.value || '',
                options: [ 
                    document.getElementById('q-opt-0-textarea')?.value || '', 
                    document.getElementById('q-opt-1-textarea')?.value || '', 
                    document.getElementById('q-opt-2-textarea')?.value || '', 
                    document.getElementById('q-opt-3-textarea')?.value || '' 
                ],
                correct: parseInt(document.getElementById('q-correct').value),
                expl: document.getElementById('q-expl-textarea')?.value || '',
                year: document.getElementById('q-year').value.trim() || null
            };
            
            // Validate - allow empty for explanation only
            if (!q.q.trim()) {
                return Swal.fire('Error', 'Question text is required', 'error');
            }
            
            // Check at least 2 options are filled
            const filledOptions = q.options.filter(opt => opt.trim()).length;
            if (filledOptions < 2) {
                return Swal.fire('Error', 'At least two options are required', 'error');
            }
            
            const editIndex = parseInt(document.getElementById('q-edit-index').value);
            if (editIndex > -1) {
                window.tempQuestions[editIndex] = q;
            } else {
                window.tempQuestions.push(q);
            }

            Teacher.clearQuestionForm();
            Teacher.renderQuestionList();
            
            // Scroll to question list
            document.getElementById('q-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
        },

        renderQuestionList: () => {
            const qCount = document.getElementById('q-count');
            const qList = document.getElementById('q-list');
            
            if (qCount) qCount.innerText = window.tempQuestions.length;
            
            if (qList) {
                let listHtml = '';
                
                if (window.tempQuestions.length === 0) {
                    listHtml = `
                    <div class="text-center p-8 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl">
                        <i class="fas fa-inbox text-4xl text-slate-400 mb-3"></i>
                        <p class="text-slate-500 dark:text-slate-400">No questions added yet</p>
                        <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">Add your first question above</p>
                    </div>`;
                } else {
                    listHtml = window.tempQuestions.map((q, i) => `
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border dark:border-slate-700 flex justify-between items-start hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                            <div class="flex-1 pr-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 text-xs font-bold px-2 py-1 rounded">Q${i + 1}</span>
                                    <span class="text-xs text-slate-500 dark:text-slate-400">Correct: ${String.fromCharCode(65 + q.correct)}</span>
                                    ${q.year ? `<span class="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-400 px-2 py-1 rounded">${q.year}</span>` : ''}
                                </div>
                                <div class="text-sm font-medium mb-2 truncate">${q.q.substring(0, 100)}${q.q.length > 100 ? '...' : ''}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">
                                    Options: ${q.options.map((opt, idx) => `<span class="mr-2">${String.fromCharCode(65 + idx)}: ${opt.substring(0, 20)}${opt.length > 20 ? '...' : ''}</span>`).join('')}
                                </div>
                            </div>
                            <div class="flex gap-2 flex-shrink-0">
                                <button onclick="Teacher.editQuestion(${i})" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/30">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Teacher.deleteQuestion(${i})" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`).join('');
                }
                
                qList.innerHTML = listHtml;
            }
        },

        editQuestion: (index) => {
            const q = window.tempQuestions[index];
            
            // Set values in textareas
            const fields = ['q-text', 'q-opt-0', 'q-opt-1', 'q-opt-2', 'q-opt-3', 'q-expl'];
            fields.forEach((fieldId, i) => {
                const textarea = document.getElementById(fieldId + '-textarea');
                if (textarea) {
                    if (i === 0) textarea.value = q.q;
                    else if (i <= 4) textarea.value = q.options[i-1];
                    else if (i === 5) textarea.value = q.expl;
                }
            });

            document.getElementById('q-correct').value = q.correct;
            document.getElementById('q-year').value = q.year || '';
            document.getElementById('q-edit-index').value = index;
            document.getElementById('add-q-btn').innerText = 'Update Question';
            document.getElementById('add-q-btn').classList.add('bg-emerald-600', 'hover:bg-emerald-700');
            
            // Focus the question field
            const textarea = document.getElementById('q-text-textarea');
            if (textarea) {
                textarea.focus();
            }
            
            // Scroll to the form
            document.querySelector('.question-input-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        },

        deleteQuestion: (index) => {
            Swal.fire({
                title: 'Delete Question?',
                text: "This action cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.tempQuestions.splice(index, 1);
                    Teacher.renderQuestionList();
                    Swal.fire('Deleted!', 'Question has been deleted.', 'success');
                }
            });
        },

        clearQuestionForm: () => {
            // Clear all textareas
            const fields = ['q-text', 'q-opt-0', 'q-opt-1', 'q-opt-2', 'q-opt-3', 'q-expl'];
            fields.forEach(fieldId => {
                const textarea = document.getElementById(fieldId + '-textarea');
                if (textarea) {
                    textarea.value = '';
                }
            });
            
            // Reset form
            document.getElementById('q-correct').value = 0;
            document.getElementById('q-year').value = '';
            document.getElementById('q-edit-index').value = -1;
            document.getElementById('add-q-btn').innerText = 'Add Question';
            document.getElementById('add-q-btn').classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
            
            // Focus on question field
            const textarea = document.getElementById('q-text-textarea');
            if (textarea) {
                textarea.focus();
            }
        },
        
        handleSubjectSelection: async (subName) => {
            if (subName === '__new_subject__') {
                const {value: n} = await Swal.fire({
                    input:'text', 
                    title:'New Subject Name', 
                    inputPlaceholder: 'Enter subject name',
                    showCancelButton: true,
                    confirmButtonText: 'Create',
                    confirmButtonColor: '#1d4ed8'
                });
                if(n) {
                    await addDoc(collection(db, "categories"), {name:n, chapters:[]});
                    await Teacher.renderForm(window.lastFormType, window.lastFormId);
                    document.getElementById('nsub').value = n;
                    Teacher.popChap(n);
                } else {
                    document.getElementById('nsub').value = '';
                }
                return;
            }
            Teacher.popChap(subName);
        },
        
        handleChapterSelection: async (chapName) => {
            if (chapName === '__new_chapter__') {
                const subName = document.getElementById('nsub').value;
                if (!subName) {
                    Swal.fire('Error', 'Please select a subject first.', 'error');
                    document.getElementById('nchap').value = '';
                    return;
                }
                const {value: n} = await Swal.fire({
                    input:'text', 
                    title:`New Chapter for ${subName}`, 
                    inputPlaceholder: 'Enter chapter name',
                    showCancelButton: true,
                    confirmButtonText: 'Create',
                    confirmButtonColor: '#1d4ed8'
                });
                if (n) {
                    const cat = window.tempCats.find(c => c.name === subName);
                    if(cat) {
                        await updateDoc(doc(db, "categories", cat.id), { chapters: arrayUnion(n) });
                        await Teacher.renderForm(window.lastFormType, window.lastFormId);
                        document.getElementById('nsub').value = subName;
                        Teacher.popChap(subName, n);
                    }
                } else {
                     document.getElementById('nchap').value = '';
                }
            }
        },
        
        popChap: (subName, selectedChap = null) => { 
            const chapSel = document.getElementById('nchap'); 
            if (!chapSel) return;
            
            chapSel.innerHTML = '<option value="">Select Chapter</option>'; 
            const cat = window.tempCats.find(c => c.name === subName); 
            if(cat && cat.chapters) { 
                cat.chapters.forEach(ch => { 
                    chapSel.innerHTML += `<option value="${ch}">${ch}</option>`; 
                }); 
            }
            if (subName) {
                chapSel.innerHTML += '<option value="__new_chapter__" class="font-bold text-blue-600 dark:text-blue-400 p-2">+ Create New Chapter</option>';
            }
            if(selectedChap) chapSel.value = selectedChap;
        },
        
        saveExam: async (status = 'published') => {
             try {
                // Check current mode
                const isJsonMode = document.getElementById('json-mode') && !document.getElementById('json-mode').classList.contains('hidden');
                
                if (isJsonMode) {
                     try {
                        window.tempQuestions = JSON.parse(document.getElementById('nq').value || '[]');
                     } catch (e) {
                        throw new Error("Invalid JSON format: " + e.message);
                     }
                }

                const id = document.getElementById('eid').value; 
                const t = document.getElementById('nt').value.trim(); 
                const type = document.getElementById('nty').value; 
                const d = document.getElementById('nd').value; 
                const m = document.getElementById('nm').value; 
                const neg = document.getElementById('nneg').value; 
                const sub = document.getElementById('nsub').value; 
                const chap = document.getElementById('nchap').value;
                
                // Validation
                if (window.tempQuestions.length === 0) {
                    throw new Error("At least one question is required.");
                }
                
                // Validate each question
                for (let i = 0; i < window.tempQuestions.length; i++) {
                    const q = window.tempQuestions[i];
                    if (!q.q || q.q.trim() === '') {
                        throw new Error(`Question ${i + 1} is empty.`);
                    }
                    if (!q.options || q.options.length !== 4) {
                        throw new Error(`Question ${i + 1} must have exactly 4 options.`);
                    }
                    for (let j = 0; j < q.options.length; j++) {
                        if (!q.options[j] || q.options[j].trim() === '') {
                            throw new Error(`Question ${i + 1}, Option ${String.fromCharCode(65 + j)} is empty.`);
                        }
                    }
                    if (q.correct < 0 || q.correct > 3) {
                        throw new Error(`Question ${i + 1} has invalid correct answer index.`);
                    }
                }
                
                let questions = JSON.stringify(window.tempQuestions);

                let st = null, et = null; 
                if(type === 'live') { 
                    st = document.getElementById('nst').value; 
                    et = document.getElementById('net').value; 
                    if(!st || !et) throw new Error("Start and End time required for Live exam."); 
                }
                
                if(!t) throw new Error("Title is required."); 
                if(!d || d <= 0) throw new Error("Valid duration is required."); 
                if(!m || m <= 0) throw new Error("Valid total marks is required."); 
                if(type === 'mock' && !sub) throw new Error("For Mock/Practice, Subject is required.");
                
                const teacherId = auth.currentUser?.uid;
                
                const data = { 
                    title: t, 
                    type, 
                    subject: sub, 
                    chapter: chap, 
                    duration: parseInt(d), 
                    totalMarks: parseInt(m), 
                    negativeMark: parseFloat(neg), 
                    questions, 
                    startTime: st, 
                    endTime: et,
                    status: status,
                    resultPublished: (type === 'mock' && status === 'published'),
                    teacherId: teacherId, // Teacher ID যোগ
                    updatedAt: new Date()
                };
                
                if(id) { 
                    // Show loading animation
                    const saveBtn = event.target;
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<div class="loader mx-auto"></div>';
                    saveBtn.disabled = true;
                    
                    await updateDoc(doc(db, "exams", id), data);
                    
                    // Update cache
                    ExamCache[id] = { id, ...data };
                    
                    // Show success animation
                    saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Updated!';
                    saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    saveBtn.classList.add('bg-green-600');
                    
                    setTimeout(async () => {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Exam updated successfully!',
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        }).then(async () => {
                            if(status === 'draft') {
                                await Teacher.draftsView();
                            } else {
                                await Teacher.historyView();
                            }
                        });
                    }, 500);
                } else { 
                    data.createdAt = new Date(); 
                    data.createdBy = teacherId;
                    
                    // Show publishing animation
                    const saveBtn = event.target;
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<div class="loader mx-auto"></div> Publishing...';
                    saveBtn.disabled = true;
                    
                    const docRef = await addDoc(collection(db, "exams"), data);
                    const newId = docRef.id;
                    
                    // Update teacher's examsCreated array
                    if (teacherId) {
                        const teacherRef = doc(db, "teachers", teacherId);
                        const teacherSnap = await getDoc(teacherRef);
                        if (teacherSnap.exists()) {
                            const teacherData = teacherSnap.data();
                            await updateDoc(teacherRef, {
                                examsCreated: arrayUnion(newId)
                            });
                        }
                    }
                    
                    // Update cache with new exam
                    ExamCache[newId] = { id: newId, ...data };
                    
                    // Success animation
                    saveBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i> Published!';
                    saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    saveBtn.classList.add('bg-green-600');
                    
                    setTimeout(async () => {
                        await Swal.fire({
                            title: '🎉 Success!',
                            html: `
                                <div class="flex flex-col items-center py-4">
                                    <div class="w-20 h-20 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mb-4">
                                        <i class="fas fa-check text-green-600 dark:text-green-400 text-3xl"></i>
                                    </div>
                                    <p class="text-lg font-bold mb-2">Exam Published Successfully!</p>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Exam is now available for students.</p>
                                </div>
                            `,
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            willClose: async () => {
                                if(status === 'draft') {
                                    await Teacher.draftsView();
                                } else {
                                    await Teacher.historyView();
                                }
                            }
                        });
                    }, 500);
                }
            } catch(e) { 
                Swal.fire('Error', e.message, 'error'); 
                // Reset button if error
                const saveBtn = event.target;
                if(saveBtn && saveBtn.innerHTML.includes('loader')) {
                    saveBtn.innerHTML = status === 'draft' ? 'Save as Draft' : 'Publish Exam';
                    saveBtn.disabled = false;
                }
            }
        },
        
        rankView: () => {
             const c = document.getElementById('app-container');
             const exams = Object.values(ExamCache).filter(e => e.status === 'published').sort((a,b) => b.createdAt - a.createdAt);
             let h = ''; 
             exams.forEach(e => { 
                 h += `
                 <div onclick="Student.openRank('${e.id}', '${e.title}')" class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border dark:border-slate-700 mb-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                     <div>
                         <div class="font-bold text-sm">${e.title}</div>
                         <div class="text-xs text-slate-400 mt-1">${e.type.toUpperCase()}</div>
                     </div>
                     <i class="fas fa-chevron-right text-slate-300"></i>
                 </div>`; 
             });
             c.innerHTML = `
             <div class="p-5 pb-20">
                 <h2 class="text-xl font-bold mb-4 font-en">Exam Rankings</h2>
                 ${h}
             </div>`;
        },
        
        viewUserAttempt: (attemptId, examId, examTitle) => {
            Student.viewResult(attemptId, {examId, examTitle});
        },
        
        managementView: () => {
            document.getElementById('app-container').innerHTML = `
            <div class="p-5 pb-20">
                <h2 class="text-xl font-bold mb-6 font-en text-slate-800 dark:text-white">Management Hub</h2>
                <div class="grid grid-cols-2 gap-4">
                     <button onclick="Teacher.publishView()" class="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 flex flex-col items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700">
                         <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/50 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 text-xl">
                             <i class="fas fa-bullhorn"></i>
                         </div>
                         <span class="font-bold text-sm text-slate-700 dark:text-slate-300">Publish Results</span>
                     </button>
                     <button onclick="Teacher.historyView()" class="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 flex flex-col items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700">
                         <div class="w-12 h-12 bg-emerald-50 dark:bg-emerald-900/50 rounded-full flex items-center justify-center text-emerald-600 dark:text-emerald-400 text-xl">
                             <i class="fas fa-list-alt"></i>
                         </div>
                         <span class="font-bold text-sm text-slate-700 dark:text-slate-300">All Exams</span>
                     </button>
                     <button onclick="Teacher.usersView()" class="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 flex flex-col items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700">
                         <div class="w-12 h-12 bg-rose-50 dark:bg-rose-900/50 rounded-full flex items-center justify-center text-rose-600 dark:text-rose-400 text-xl">
                             <i class="fas fa-users"></i>
                         </div>
                         <span class="font-bold text-sm text-slate-700 dark:text-slate-300">Students</span>
                     </button>
                     <button onclick="Teacher.folderManagementView()" class="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 flex flex-col items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700">
                         <div class="w-12 h-12 bg-purple-50 dark:bg-purple-900/50 rounded-full flex items-center justify-center text-purple-600 dark:text-purple-400 text-xl">
                             <i class="fas fa-folder-tree"></i>
                         </div>
                         <span class="font-bold text-sm text-slate-700 dark:text-slate-300">Folder Management</span>
                     </button>
                     <button onclick="Teacher.draftsView()" class="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 flex flex-col items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700">
                         <div class="w-12 h-12 bg-amber-50 dark:bg-amber-900/50 rounded-full flex items-center justify-center text-amber-600 dark:text-amber-400 text-xl">
                             <i class="fas fa-file-draft"></i>
                         </div>
                         <span class="font-bold text-sm text-slate-700 dark:text-slate-300">Drafts</span>
                     </button>
                </div>
            </div>`;
        },
        
        // Teacher প্রোফাইল ভিউ
        profileView: async () => {
            const c = document.getElementById('app-container');
            const teacherId = auth.currentUser?.uid;
            
            try {
                // Load teacher data from Firestore
                const teacherDoc = await getDoc(doc(db, "teachers", teacherId));
                
                if (teacherDoc.exists()) {
                    const teacherData = teacherDoc.data();
                    
                    // Load student count
                    const studentsCount = teacherData.students?.length || 0;
                    
                    // Load exams created count
                    const examsCreated = teacherData.examsCreated?.length || 0;
                    
                    c.innerHTML = `
                    <div class="p-5 pb-20 max-w-md mx-auto">
                        <button onclick="Router.teacher('management')" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i> Back to Management
                        </button>
                        
                        <div class="text-center mb-8">
                            <div class="w-24 h-24 bg-gradient-to-r from-blue-500 to-blue-700 rounded-full mx-auto text-white flex items-center justify-center text-3xl font-bold mb-4 shadow-lg border-4 border-white dark:border-slate-800">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">${teacherData.name}</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${teacherData.email}</p>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm border dark:border-slate-700 mb-6">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                <i class="fas fa-id-card text-blue-500"></i> Teacher Information
                            </h3>
                            
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                                    <div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">Teacher Code</div>
                                        <div class="font-bold text-lg font-mono text-blue-600 dark:text-blue-400">${teacherData.teacherCode}</div>
                                    </div>
                                    <div class="text-blue-500">
                                        <i class="fas fa-copy text-xl cursor-pointer" onclick="copyToClipboard('${teacherData.teacherCode}')" title="Copy Code"></i>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                                        <div class="text-xs text-slate-500 dark:text-slate-400">Students</div>
                                        <div class="font-bold text-xl">${studentsCount}</div>
                                    </div>
                                    <div class="p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                                        <div class="text-xs text-slate-500 dark:text-slate-400">Exams Created</div>
                                        <div class="font-bold text-xl">${examsCreated}</div>
                                    </div>
                                </div>
                                
                                <div class="p-3 bg-amber-50 dark:bg-amber-900/30 rounded-lg border border-amber-200 dark:border-amber-800">
                                    <div class="flex items-start gap-2">
                                        <i class="fas fa-exclamation-triangle text-amber-500 mt-1"></i>
                                        <div class="text-xs text-amber-700 dark:text-amber-300">
                                            <div class="font-bold mb-1">Important Notice:</div>
                                            Your teacher code is permanent and cannot be changed. Share it with your students so they can connect with you.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="Teacher.showStudentsList()" class="w-full bg-white dark:bg-slate-800 border dark:border-slate-700 text-slate-800 dark:text-slate-200 py-4 rounded-xl font-bold mb-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-users"></i> View My Students
                        </button>
                        
                        <button onclick="Auth.confirmLogout()" class="w-full bg-red-50 dark:bg-red-900/50 text-red-600 dark:text-red-400 py-4 rounded-xl font-bold hover:bg-red-100 dark:hover:bg-red-900 transition">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>`;
                    
                    // ক্লিপবোর্ডে কপি ফাংশন সংযুক্ত
                    window.copyToClipboard = (text) => {
                        navigator.clipboard.writeText(text).then(() => {
                            Swal.fire({
                                title: 'Copied!',
                                text: 'Teacher code copied to clipboard',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        });
                    };
                }
            } catch (error) {
                console.error("Error loading teacher profile:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <div class="text-red-500 p-4">Error loading profile: ${error.message}</div>
                </div>`;
            }
        },
        
        // Teacher এর Students লিস্ট ভিউ
        showStudentsList: async () => {
            const c = document.getElementById('app-container');
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                const teacherId = auth.currentUser?.uid;
                const teacherDoc = await getDoc(doc(db, "teachers", teacherId));
                
                if (teacherDoc.exists()) {
                    const teacherData = teacherDoc.data();
                    const studentIds = teacherData.students || [];
                    
                    let studentsData = [];
                    
                    // প্রতিটি student এর ডাটা লোড করি
                    for (const studentId of studentIds) {
                        const studentDoc = await getDoc(doc(db, "users", studentId));
                        if (studentDoc.exists()) {
                            studentsData.push({
                                id: studentId,
                                ...studentDoc.data()
                            });
                        }
                    }
                    
                    let studentsHtml = '';
                    if (studentsData.length === 0) {
                        studentsHtml = `
                        <div class="text-center py-12 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl">
                            <i class="fas fa-user-graduate text-4xl text-slate-400 mb-4"></i>
                            <p class="text-slate-500 dark:text-slate-400">No students connected yet</p>
                            <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">Share your teacher code with students</p>
                        </div>`;
                    } else {
                        studentsHtml = studentsData.map(student => `
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 mb-3">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                                    ${student.name ? student.name[0].toUpperCase() : 'S'}
                                </div>
                                <div class="flex-1">
                                    <div class="font-bold text-sm">${student.name}</div>
                                    <div class="text-xs text-slate-500">${student.email}</div>
                                </div>
                            </div>
                            <div class="text-xs text-slate-400">
                                Joined: ${student.joined ? moment(student.joined.toDate()).format('DD MMM YYYY') : 'N/A'}
                            </div>
                        </div>`).join('');
                    }
                    
                    c.innerHTML = `
                    <div class="p-5 pb-20">
                        <button onclick="Teacher.profileView()" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i> Back to Profile
                        </button>
                        
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/50 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">My Students</h2>
                                <p class="text-sm text-slate-500 dark:text-slate-400">${studentsData.length} students connected</p>
                            </div>
                        </div>
                        
                        ${studentsHtml}
                    </div>`;
                }
            } catch (error) {
                console.error("Error loading students:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.profileView()" class="mb-4">← Back</button>
                    <div class="text-red-500 p-4">Error loading students: ${error.message}</div>
                </div>`;
            }
        },
        
        // New: Folder Management View
        folderManagementView: async () => {
            const c = document.getElementById('app-container');
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            const catSnap = await getDocs(query(collection(db, "categories"), orderBy("name")));
            let categories = [];
            catSnap.forEach(d => {
                categories.push({ id: d.id, ...d.data() });
            });
            
            let html = `
            <div class="p-5 pb-20">
                <button onclick="Teacher.managementView()" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-300 flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Back to Management
                </button>
                <h2 class="text-2xl font-bold mb-6 font-en">Folder Management</h2>
                
                <div class="mb-6">
                    <button onclick="Teacher.addNewSubject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-blue-700 transition">
                        <i class="fas fa-plus"></i> Add New Subject
                    </button>
                </div>
                
                <div class="space-y-4">`;
            
            if (categories.length === 0) {
                html += `
                <div class="text-center py-12 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl">
                    <i class="fas fa-folder-open text-4xl text-slate-400 mb-4"></i>
                    <p class="text-slate-500 dark:text-slate-400">No subjects found</p>
                    <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">Create your first subject to organize exams</p>
                </div>`;
            } else {
                categories.forEach(cat => {
                    html += `
                    <div class="bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 overflow-hidden">
                        <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition"
                             onclick="Teacher.toggleSubjectChapters('${cat.id}')">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/50 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-folder text-amber-600 dark:text-amber-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 dark:text-slate-200">${cat.name}</h3>
                                    <p class="text-xs text-slate-500">${cat.chapters?.length || 0} chapters</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex gap-1">
                                    <button onclick="event.stopPropagation(); Teacher.editSubject('${cat.id}', '${cat.name}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-2">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); Teacher.deleteSubject('${cat.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-2">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <i id="chevron-${cat.id}" class="fas fa-chevron-down text-slate-400 transition-transform"></i>
                            </div>
                        </div>
                        
                        <div id="chapters-${cat.id}" class="hidden border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                            <div class="p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-slate-700 dark:text-slate-300">Chapters</h4>
                                    <button onclick="Teacher.addChapter('${cat.id}', '${cat.name}')" class="text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1.5 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">
                                        <i class="fas fa-plus mr-1"></i> Add Chapter
                                    </button>
                                </div>
                                
                                <div id="chapter-list-${cat.id}" class="space-y-2">
                                    ${cat.chapters && cat.chapters.length > 0 ? 
                                        cat.chapters.map((chap, index) => `
                                        <div class="flex justify-between items-center p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-file-alt text-blue-500"></i>
                                                <span class="font-medium text-slate-700 dark:text-slate-300">${chap}</span>
                                            </div>
                                            <div class="flex gap-1">
                                                <button onclick="Teacher.editChapter('${cat.id}', ${index}, '${chap}')" class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 px-2 py-1">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="Teacher.deleteChapter('${cat.id}', ${index}, '${chap}')" class="text-xs text-red-600 dark:text-red-400 hover:text-red-800 px-2 py-1">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>`).join('') : 
                                        `<p class="text-sm text-slate-500 dark:text-slate-400 italic text-center py-2">No chapters added yet</p>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
            }
            
            html += `</div></div>`;
            
            c.innerHTML = html;
        },

        toggleSubjectChapters: (catId) => {
            const chaptersDiv = document.getElementById(`chapters-${catId}`);
            const chevron = document.getElementById(`chevron-${catId}`);
            
            if (chaptersDiv.classList.contains('hidden')) {
                chaptersDiv.classList.remove('hidden');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                chaptersDiv.classList.add('hidden');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        },
        
        addNewSubject: async () => {
            const { value: subjectName } = await Swal.fire({
                title: 'Add New Subject',
                input: 'text',
                inputLabel: 'Subject Name',
                inputPlaceholder: 'Enter subject name',
                showCancelButton: true,
                confirmButtonText: 'Add',
                confirmButtonColor: '#1d4ed8'
            });
            
            if (subjectName) {
                try {
                    await addDoc(collection(db, "categories"), {
                        name: subjectName,
                        chapters: [],
                        createdAt: new Date()
                    });
                    Swal.fire('Success', 'Subject added successfully!', 'success');
                    Teacher.folderManagementView();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        editSubject: async (id, currentName) => {
            const { value: newName } = await Swal.fire({
                title: 'Edit Subject',
                input: 'text',
                inputLabel: 'Subject Name',
                inputValue: currentName,
                showCancelButton: true,
                confirmButtonText: 'Update',
                confirmButtonColor: '#1d4ed8'
            });
            
            if (newName && newName !== currentName) {
                try {
                    await updateDoc(doc(db, "categories", id), {
                        name: newName
                    });
                    Swal.fire('Success', 'Subject updated successfully!', 'success');
                    Teacher.folderManagementView();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        deleteSubject: async (id) => {
            const result = await Swal.fire({
                title: 'Delete Subject?',
                text: "All chapters under this subject will also be deleted!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete it!'
            });
            
            if (result.isConfirmed) {
                try {
                    await deleteDoc(doc(db, "categories", id));
                    Swal.fire('Deleted!', 'Subject has been deleted.', 'success');
                    Teacher.folderManagementView();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        addChapter: async (catId, catName) => {
            const { value: chapterName } = await Swal.fire({
                title: `Add Chapter to ${catName}`,
                input: 'text',
                inputLabel: 'Chapter Name',
                inputPlaceholder: 'Enter chapter name',
                showCancelButton: true,
                confirmButtonText: 'Add',
                confirmButtonColor: '#1d4ed8'
            });
            
            if (chapterName) {
                try {
                    const catRef = doc(db, "categories", catId);
                    const catSnap = await getDoc(catRef);
                    const currentChapters = catSnap.data().chapters || [];
                    
                    await updateDoc(catRef, {
                        chapters: [...currentChapters, chapterName]
                    });
                    
                    Swal.fire('Success', 'Chapter added successfully!', 'success');
                    Teacher.folderManagementView();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        editChapter: async (catId, index, currentName) => {
            const { value: newName } = await Swal.fire({
                title: 'Edit Chapter',
                input: 'text',
                inputLabel: 'Chapter Name',
                inputValue: currentName,
                showCancelButton: true,
                confirmButtonText: 'Update',
                confirmButtonColor: '#1d4ed8'
            });
            
            if (newName && newName !== currentName) {
                try {
                    const catRef = doc(db, "categories", catId);
                    const catSnap = await getDoc(catRef);
                    const currentChapters = catSnap.data().chapters || [];
                    
                    currentChapters[index] = newName;
                    
                    await updateDoc(catRef, {
                        chapters: currentChapters
                    });
                    
                    Swal.fire('Success', 'Chapter updated successfully!', 'success');
                    Teacher.folderManagementView();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        deleteChapter: async (catId, index, chapterName) => {
            const result = await Swal.fire({
                title: 'Delete Chapter?',
                text: `Are you sure you want to delete "${chapterName}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, delete it!'
            });
            
            if (result.isConfirmed) {
                try {
                    const catRef = doc(db, "categories", catId);
                    const catSnap = await getDoc(catRef);
                    const currentChapters = catSnap.data().chapters || [];
                    
                    currentChapters.splice(index, 1);
                    
                    await updateDoc(catRef, {
                        chapters: currentChapters
                    });
                    
                    Swal.fire('Deleted!', 'Chapter has been deleted.', 'success');
                    Teacher.folderManagementView();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        // New: Drafts View
        draftsView: async () => {
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                // Direct query for drafts
                const snap = await getDocs(query(collection(db, "exams"), where("status", "==", "draft"), orderBy("createdAt", "desc")));
                
                let h = ''; 
                snap.forEach(d => { 
                    const e = {id: d.id, ...d.data()}; 
                    h += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 mb-3 flex justify-between items-center">
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm truncate">${e.title}</div>
                            <div class="text-xs text-slate-400 capitalize flex items-center gap-2">
                                <span class="bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 px-2 py-0.5 rounded text-[10px] font-bold">DRAFT</span>
                                <span>${e.type} • ${e.subject || 'No Subject'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            <button onclick="Teacher.renderForm(null, '${e.id}')" class="text-blue-500 bg-blue-50 dark:bg-blue-900/50 px-2 py-1 rounded">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="Teacher.publishDraft('${e.id}')" class="text-emerald-500 bg-emerald-50 dark:bg-emerald-900/50 px-2 py-1 rounded">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button onclick="Teacher.del('${e.id}')" class="text-red-500 bg-red-50 dark:bg-red-900/50 px-2 py-1 rounded">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`; 
                });
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.managementView()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 class="text-xl font-bold mb-4 font-en">Draft Exams</h2>
                    ${h || '<div class="text-center p-10 text-slate-400">No draft exams found</div>'}
                </div>`;
            } catch (error) {
                console.error("Error loading drafts:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.managementView()" class="mb-4">← Back</button>
                    <div class="text-red-500 p-4">Error loading drafts: ${error.message}</div>
                </div>`;
            }
        },
        
        publishDraft: async (id) => {
            const result = await Swal.fire({
                title: 'Publish Draft?',
                text: "This exam will become visible to students.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, publish it!'
            });
            
            if (result.isConfirmed) {
                try {
                    await updateDoc(doc(db, "exams", id), {
                        status: 'published',
                        resultPublished: true
                    });
                    
                    // Update cache
                    if (ExamCache[id]) {
                        ExamCache[id].status = 'published';
                        ExamCache[id].resultPublished = true;
                    }
                    
                    Swal.fire('Published!', 'Exam has been published.', 'success');
                    Teacher.draftsView();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        },
        
        publishView: async () => {
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                // Direct query for live exams
                const snap = await getDocs(query(collection(db, "exams"), where("type", "==", "live"), orderBy("createdAt", "desc")));
                
                let h = ''; 
                snap.forEach(d => { 
                    const e = d.data(); 
                    const btn = e.resultPublished ? 
                        `<span class="text-emerald-500 font-bold text-xs"><i class="fas fa-check"></i> Published</span>` : 
                        `<button onclick="Teacher.publish('${d.id}')" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold">Publish</button>`; 
                    h += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 mb-3 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-sm">${e.title}</div>
                            <div class="text-xs text-slate-400 capitalize">${e.type} Exam</div>
                        </div>
                        <div>${btn}</div>
                    </div>`; 
                });
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.managementView()" class="mb-4 text-xs font-bold text-slate-500 dark:text-slate-400">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 class="text-xl font-bold mb-4 font-en">Manage Results</h2>
                    ${h || '<div class="text-center p-10 text-slate-400">No live exams found</div>'}
                </div>`;
            } catch (error) {
                console.error("Error loading publish view:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.managementView()" class="mb-4">← Back</button>
                    <div class="text-red-500 p-4">Error: ${error.message}</div>
                </div>`;
            }
        },
        
        publish: async (id) => { 
            Swal.fire({ 
                title:'Publish Result?', 
                text: "Users will see the result immediately.", 
                icon:'question', 
                showCancelButton:true, 
                confirmButtonColor:'#1d4ed8', 
                confirmButtonText:'Yes, Publish' 
            }).then(async(r)=>{
                if(r.isConfirmed) { 
                    await updateDoc(doc(db, "exams", id), { resultPublished: true }); 
                    
                    // Update cache
                    if (ExamCache[id]) {
                        ExamCache[id].resultPublished = true;
                    }
                    
                    Swal.fire('Published', 'Result is now live', 'success'); 
                    Teacher.publishView();
                } 
            }); 
        },
        
        historyView: async () => {
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                // Refresh cache first
                await refreshExamCache();
                
                // Filter out drafts for published view
                const publishedExams = Object.values(ExamCache).filter(e => e.status !== 'draft');
                
                // Separate live and mock exams
                const liveExams = publishedExams.filter(e => e.type === 'live');
                const mockExams = publishedExams.filter(e => e.type === 'mock');
                
                // Group mock exams by subject and chapter
                let mockStructure = {};
                mockExams.forEach(e => {
                    const subject = e.subject || "General";
                    const chapter = e.chapter || "Uncategorized";
                    
                    if (!mockStructure[subject]) {
                        mockStructure[subject] = {};
                    }
                    if (!mockStructure[subject][chapter]) {
                        mockStructure[subject][chapter] = [];
                    }
                    mockStructure[subject][chapter].push(e);
                });
                
                let html = `
                <div class="p-5 pb-20 animate-[fadeIn_0.5s]">
                    <button onclick="Teacher.managementView()" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to Management
                    </button>
                    <h2 class="text-2xl font-bold mb-8 font-en">All Exams - File Manager</h2>
                    
                    <!-- Folder Container with Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                        <!-- Live Exams Folder Card -->
                        <div class="folder-card bg-gradient-to-br from-indigo-500/10 to-purple-500/10 dark:from-indigo-900/30 dark:to-purple-900/30 border-2 border-indigo-200 dark:border-indigo-800 rounded-2xl p-6 cursor-pointer hover:scale-[1.02] transition-all duration-300 hover:shadow-xl hover:border-indigo-300 dark:hover:border-indigo-700"
                             onclick="Teacher.openLiveExams()">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="folder-icon-container w-12 h-12 bg-indigo-100 dark:bg-indigo-900/50 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-bolt text-xl text-indigo-600 dark:text-indigo-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg text-indigo-800 dark:text-indigo-200">Live Exams</h3>
                                        <p class="text-xs text-indigo-600/70 dark:text-indigo-400/70">Scheduled exams for students</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">${liveExams.length}</div>
                                    <div class="text-xs text-indigo-600/60 dark:text-indigo-400/60">exams</div>
                                </div>
                            </div>
                            <div class="text-xs text-indigo-700/80 dark:text-indigo-300/80 flex items-center justify-between mt-4">
                                <span>Click to view all live exams</span>
                                <i class="fas fa-arrow-right text-indigo-600 dark:text-indigo-400"></i>
                            </div>
                        </div>
                        
                        <!-- Mock Exams Folder Card -->
                        <div class="folder-card bg-gradient-to-br from-emerald-500/10 to-teal-500/10 dark:from-emerald-900/30 dark:to-teal-900/30 border-2 border-emerald-200 dark:border-emerald-800 rounded-2xl p-6 cursor-pointer hover:scale-[1.02] transition-all duration-300 hover:shadow-xl hover:border-emerald-300 dark:hover:border-emerald-700"
                             onclick="Teacher.openMockExams()">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="folder-icon-container w-12 h-12 bg-emerald-100 dark:bg-emerald-900/50 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-book-open text-xl text-emerald-600 dark:text-emerald-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg text-emerald-800 dark:text-emerald-200">Mock Exams</h3>
                                        <p class="text-xs text-emerald-600/70 dark:text-emerald-400/70">Practice tests organized by subject</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-emerald-700 dark:text-emerald-300">${mockExams.length}</div>
                                    <div class="text-xs text-emerald-600/60 dark:text-emerald-400/60">exams</div>
                                </div>
                            </div>
                            <div class="text-xs text-emerald-700/80 dark:text-emerald-300/80 flex items-center justify-between mt-4">
                                <span>Click to view all practice exams</span>
                                <i class="fas fa-arrow-right text-emerald-600 dark:text-emerald-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity Section -->
                    <div class="mt-8">
                        <h3 class="font-bold text-lg mb-4">Recent Activity</h3>
                        <div class="space-y-3">
                            ${publishedExams.slice(0, 5).map(e => `
                                <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm">${e.title}</div>
                                        <div class="text-xs text-slate-500 capitalize mt-1">
                                            <span class="bg-${e.type === 'live' ? 'indigo' : 'emerald'}-100 dark:bg-${e.type === 'live' ? 'indigo' : 'emerald'}-900/30 text-${e.type === 'live' ? 'indigo' : 'emerald'}-800 dark:text-${e.type === 'live' ? 'indigo' : 'emerald'}-400 px-2 py-0.5 rounded text-[10px] mr-2">${e.type}</span>
                                            ${moment(e.createdAt?.toDate()).fromNow()}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="event.stopPropagation(); Teacher.editExam('${e.id}')" class="text-sm bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">
                                            Edit
                                        </button>
                                        <button onclick="event.stopPropagation(); Teacher.viewResults('${e.id}')" class="text-sm bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 px-3 py-1 rounded hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition">
                                            Results
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
                
                c.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading history view:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.managementView()" class="mb-4">← Back</button>
                    <div class="text-red-500 p-4">Error loading exams: ${error.message}</div>
                </div>`;
            }
        },

        openLiveExams: async () => {
            const c = document.getElementById('app-container');
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                // Direct query for live exams
                const snap = await getDocs(query(collection(db, "exams"), where("type", "==", "live"), orderBy("createdAt", "desc")));
                
                let liveExams = [];
                snap.forEach(d => {
                    const e = d.data();
                    if (e.status !== 'draft') {
                        liveExams.push({ id: d.id, ...e });
                    }
                });
                
                const html = `
                <div class="p-5 pb-20 animate-[slideIn_0.4s]">
                    <button onclick="Teacher.historyView()" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to All Exams
                    </button>
                    
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/50 rounded-xl flex items-center justify-center">
                            <i class="fas fa-bolt text-xl text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-blue-800 dark:text-blue-200">Live Exams</h2>
                            <p class="text-sm text-blue-600/70 dark:text-blue-400/70">All scheduled live examinations</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${liveExams.length === 0 ? `
                            <div class="text-center py-12 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl">
                                <i class="fas fa-calendar-times text-4xl text-slate-400 mb-4"></i>
                                <p class="text-slate-500 dark:text-slate-400">No live exams scheduled yet</p>
                            </div>
                        ` : liveExams.map(e => Teacher.examItemHTML(e)).join('')}
                    </div>
                </div>`;
                
                c.innerHTML = html;
            } catch (error) {
                console.error("Error loading live exams:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.historyView()" class="mb-4">← Back</button>
                    <div class="text-red-500 p-4">Error: ${error.message}</div>
                </div>`;
            }
        },

        openMockExams: async () => {
            const c = document.getElementById('app-container');
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                // Direct query for mock exams
                const snap = await getDocs(query(collection(db, "exams"), where("type", "==", "mock"), orderBy("createdAt", "desc")));
                
                let mockExams = [];
                let mockStructure = {};
                
                snap.forEach(d => {
                    const e = d.data();
                    if (e.status !== 'draft') {
                        mockExams.push({ id: d.id, ...e });
                        
                        const subject = e.subject || "General";
                        const chapter = e.chapter || "Uncategorized";
                        
                        if (!mockStructure[subject]) {
                            mockStructure[subject] = {};
                        }
                        if (!mockStructure[subject][chapter]) {
                            mockStructure[subject][chapter] = [];
                        }
                        mockStructure[subject][chapter].push({ id: d.id, ...e });
                    }
                });
                
                const html = `
                <div class="p-5 pb-20 animate-[slideIn_0.4s]">
                    <button onclick="Teacher.historyView()" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-emerald-600 dark:hover:text-emerald-400 transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to All Exams
                    </button>
                    
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/50 rounded-xl flex items-center justify-center">
                            <i class="fas fa-book-open text-xl text-emerald-600 dark:text-emerald-400"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-emerald-800 dark:text-emerald-200">Mock Exams</h2>
                            <p class="text-sm text-emerald-600/70 dark:text-emerald-400/70">Organized by subject and chapter</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        ${Object.keys(mockStructure).length === 0 ? `
                            <div class="text-center py-12 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl">
                                <i class="fas fa-folder-open text-4xl text-slate-400 mb-4"></i>
                                <p class="text-slate-500 dark:text-slate-400">No mock exams created yet</p>
                            </div>
                        ` : Object.keys(mockStructure).map(subject => `
                            <div class="subject-folder bg-gradient-to-r from-slate-50 to-white dark:from-slate-800/50 dark:to-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
                                <div class="subject-header bg-slate-100 dark:bg-slate-800 p-4 flex justify-between items-center cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition"
                                     onclick="this.nextElementSibling.classList.toggle('hidden')">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-folder text-lg text-amber-500"></i>
                                        <h3 class="font-bold text-slate-800 dark:text-slate-200">${subject}</h3>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded">
                                            ${Object.keys(mockStructure[subject]).length} chapters
                                        </span>
                                        <i class="fas fa-chevron-down text-slate-400 transition-transform"></i>
                                    </div>
                                </div>
                                <div class="chapter-content hidden p-4 border-t border-slate-200 dark:border-slate-700">
                                    ${Object.keys(mockStructure[subject]).map(chapter => `
                                        <div class="mb-6 last:mb-0">
                                            <div class="chapter-header mb-3 flex justify-between items-center">
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-file-alt text-sm text-blue-500"></i>
                                                    <h4 class="font-semibold text-slate-700 dark:text-slate-300">${chapter}</h4>
                                                </div>
                                                <span class="text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-1 rounded">
                                                    ${mockStructure[subject][chapter].length} exams
                                                </span>
                                            </div>
                                            <div class="exam-list pl-6 space-y-3">
                                                ${mockStructure[subject][chapter].map(e => Teacher.examItemHTML(e)).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
                
                c.innerHTML = html;
            } catch (error) {
                console.error("Error loading mock exams:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.historyView()" class="mb-4">← Back</button>
                    <div class="text-red-500 p-4">Error: ${error.message}</div>
                </div>`;
            }
        },

        editExam: async (id) => {
            try {
                const examRef = doc(db, "exams", id);
                const examSnap = await getDoc(examRef);
                
                if (examSnap.exists()) {
                    const exam = { id: examSnap.id, ...examSnap.data() };
                    await Teacher.renderForm(null, exam.id);
                } else {
                    Swal.fire('Error', 'Exam not found', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Failed to load exam: ' + error.message, 'error');
            }
        },
        
        examItemHTML: (e) => {
            return `
            <div class="exam-item bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 mb-3 hover:shadow-md transition-all duration-300 hover:scale-[1.005]">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm truncate">${e.title}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400 capitalize mt-2">
                            <span class="inline-flex items-center gap-1 bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded mr-2">
                                <i class="fas fa-${e.type === 'live' ? 'bolt' : 'book-open'} text-[10px]"></i>
                                ${e.type}
                            </span>
                            <span class="mr-2">${e.duration} min</span>
                            <span>${e.totalMarks} marks</span>
                        </div>
                    </div>
                    <span class="text-xs font-bold ${e.status === 'published' ? 'text-emerald-600 dark:text-emerald-400' : 'text-amber-600 dark:text-amber-400'} bg-${e.status === 'published' ? 'emerald' : 'amber'}-50 dark:bg-${e.status === 'published' ? 'emerald' : 'amber'}-900/30 px-2 py-1 rounded ml-2">
                        ${e.status === 'published' ? 'Published' : 'Draft'}
                    </span>
                </div>
                
                <div class="flex gap-2 mt-4 pt-3 border-t dark:border-slate-700">
                    <button onclick="event.stopPropagation(); Teacher.editExam('${e.id}')" 
                            class="flex-1 text-xs font-bold py-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-all duration-300 flex items-center justify-center gap-1">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button onclick="event.stopPropagation(); Teacher.viewPaper('${e.id}')" 
                            class="flex-1 text-xs font-bold py-2 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-all duration-300 flex items-center justify-center gap-1">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button onclick="event.stopPropagation(); Teacher.viewResults('${e.id}')" 
                            class="flex-1 text-xs font-bold py-2 bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-all duration-300 flex items-center justify-center gap-1">
                        <i class="fas fa-chart-bar"></i> Results
                    </button>
                </div>
            </div>`;
        },
        
        viewResults: (examId) => {
            Student.openRank(examId, ExamCache[examId]?.title || 'Exam Results');
        },
        
        viewPaper: (id) => { 
            const e = ExamCache[id]; 
            if(!e) return; 
            const qs = JSON.parse(e.questions); 
            let h = qs.map((q,i) => `
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl mb-4 border dark:border-blue-800/50 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <div class="font-bold text-sm text-blue-700 dark:text-blue-400">Q${i+1}. ${q.q}</div>
                    ${q.year ? `<span class="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-400 px-2 py-1 rounded">${q.year}</span>` : ''}
                </div>
                <div class="space-y-1 mb-2">
                    ${q.options.map((o, oi) => `
                        <div class="text-xs p-2 rounded border ${oi===q.correct ? 'bg-emerald-100 dark:bg-emerald-900/50 border-emerald-300 dark:border-emerald-700 font-bold text-emerald-800 dark:text-emerald-300' : 'bg-slate-50 dark:bg-slate-700/50 border-slate-100 dark:border-slate-700 text-slate-500'}">
                            ${String.fromCharCode(65+oi)}. ${o}
                        </div>`).join('')}
                </div>
                <div class="text-xs bg-slate-50 dark:bg-slate-700/50 p-2 rounded border dark:border-slate-700">
                    <b>Expl:</b> ${q.expl}
                </div>
            </div>`).join(''); 
            document.getElementById('app-container').innerHTML = `
            <div class="p-5 pb-20">
                <button onclick="Teacher.historyView()" class="mb-4 text-xs font-bold">Back</button>
                <h2 class="text-lg font-bold mb-4">${e.title} (Key)</h2>
                ${h}
            </div>`; 
            MathJax.typesetPromise(); 
        },
        
        del: async (id) => { 
            Swal.fire({ 
                title:'Delete Exam?', 
                text: "This will also delete all user attempts for this exam.", 
                icon:'warning', 
                showCancelButton:true, 
                confirmButtonColor:'#ef4444', 
                confirmButtonText:'Yes, Delete' 
            }).then(async(r)=>{
                if(r.isConfirmed) { 
                    try {
                        // Delete attempts first
                        const attemptsQuery = query(collection(db, "attempts"), where("examId", "==", id));
                        const attemptsSnap = await getDocs(attemptsQuery);
                        const batch = writeBatch(db);
                        
                        attemptsSnap.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        // Delete exam
                        batch.delete(doc(db, "exams", id));
                        await batch.commit();
                        
                        // Remove from cache immediately
                        delete ExamCache[id];
                        
                        Swal.fire('Deleted','Exam deleted successfully','success');
                        
                        // Refresh current view
                        Teacher.historyView();
                        
                    } catch (error) {
                        console.error("Delete error:", error);
                        Swal.fire('Error', 'Failed to delete: ' + error.message, 'error');
                    }
                }
            }); 
        },
        
        // Updated usersView with modern design
        usersView: async () => { 
            const c = document.getElementById('app-container'); 
            c.innerHTML = '<div class="p-10 text-center"><div class="loader mx-auto"></div></div>';
            
            try {
                // Get teacher's students
                const teacherId = auth.currentUser?.uid;
                const teacherDoc = await getDoc(doc(db, "teachers", teacherId));
                
                let students = [];
                if (teacherDoc.exists()) {
                    const teacherData = teacherDoc.data();
                    const studentIds = teacherData.students || [];
                    
                    // Load each student's data
                    for (const studentId of studentIds) {
                        const studentDoc = await getDoc(doc(db, "users", studentId));
                        if (studentDoc.exists()) {
                            students.push({id: studentId, ...studentDoc.data()});
                        }
                    }
                }
                
                students.sort((a,b) => (b.joined?.toDate() || 0) - (a.joined?.toDate() || 0));
                window.cachedStudents = students; 
                
                const renderStudents = (list) => { 
                    let h = ''; 
                    list.forEach(u => { 
                        // User status indicators
                        const isBlocked = u.blocked;
                        const isDisabled = u.disabled;
                        
                        // Status badges
                        let statusBadges = '';
                        if (isBlocked) {
                            statusBadges = `<span class="inline-flex items-center gap-1 bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-red-900 dark:text-red-300">
                                <i class="fas fa-ban text-xs"></i> Blocked
                            </span>`;
                        } else if (isDisabled) {
                            statusBadges = `<span class="inline-flex items-center gap-1 bg-amber-100 text-amber-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-amber-900 dark:text-amber-300">
                                <i class="fas fa-pause-circle text-xs"></i> Disabled
                            </span>`;
                        } else {
                            statusBadges = `<span class="inline-flex items-center gap-1 bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-emerald-900 dark:text-emerald-300">
                                <i class="fas fa-check-circle text-xs"></i> Active
                            </span>`;
                        }
                        
                        h += `
                        <div class="bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 shadow-sm hover:shadow-md transition-shadow">
                            <div class="p-4">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start space-x-3 flex-1 min-w-0">
                                        <div class="relative flex-shrink-0">
                                            <div class="w-12 h-12 rounded-full ${isBlocked ? 'bg-gradient-to-r from-red-500 to-rose-500' : isDisabled ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 'bg-gradient-to-r from-indigo-500 to-purple-500'} flex items-center justify-center text-white font-bold text-lg shadow">
                                                ${u.name ? u.name[0].toUpperCase() : 'S'}
                                            </div>
                                            ${isBlocked ? `
                                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-red-500 rounded-full border-2 border-white dark:border-slate-800 flex items-center justify-center">
                                                    <i class="fas fa-ban text-white text-[8px]"></i>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <div class="font-bold text-sm text-slate-800 dark:text-white truncate">${u.name || 'No Name'}</div>
                                                ${isBlocked ? '<i class="fas fa-shield-alt text-red-500 text-xs"></i>' : ''}
                                            </div>
                                            <div class="text-xs text-slate-500 dark:text-slate-400 truncate mb-2">${u.email}</div>
                                            <div class="flex items-center flex-wrap gap-1">
                                                ${statusBadges}
                                                <span class="text-xs text-slate-400">${u.joined ? moment(u.joined.toDate()).format('DD/MM/YY') : 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Mobile-friendly action menu -->
                                    <div class="relative flex-shrink-0 ml-2">
                                        <button onclick="Teacher.showStudentActions('${u.id}', '${u.name || u.email}', ${isBlocked}, ${isDisabled})" 
                                                class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`; 
                    }); 
                    return h || '<div class="text-center p-10 text-slate-400">No students found</div>'; 
                };
                
                c.innerHTML = `
                <div class="p-5 pb-20 animate-[fadeIn_0.5s]">
                    <button onclick="Teacher.managementView()" class="mb-6 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 class="text-2xl font-bold mb-2 font-en">Student Management</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Total Students: ${students.length}</p>
                    
                    <!-- Search Bar - Mobile Responsive -->
                    <div class="mb-6">
                        <div class="relative">
                            <input type="text" id="student-search" placeholder="Search students..." 
                                   class="w-full pl-10 pr-4 py-3 border dark:border-slate-700 bg-white dark:bg-slate-800 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        </div>
                    </div>
                    
                    <div id="student-list" class="space-y-3">
                        ${renderStudents(students)}
                    </div>
                </div>`;
                
                const searchInput = document.getElementById('student-search');
                if (searchInput) {
                    searchInput.addEventListener('keyup', (e) => { 
                        const val = e.target.value.toLowerCase(); 
                        document.getElementById('student-list').innerHTML = renderStudents(
                            window.cachedStudents.filter(u => 
                                (u.name?.toLowerCase() || '').includes(val) || 
                                (u.email?.toLowerCase() || '').includes(val)
                            )
                        ); 
                    });
                }
            } catch (error) {
                console.error("Error loading students:", error);
                c.innerHTML = `
                <div class="p-5 pb-20">
                    <button onclick="Teacher.managementView()" class="mb-4">← Back</button>
                    <div class="text-red-500 p-4">Error loading students: ${error.message}</div>
                </div>`;
            }
        },

        // নতুন student অ্যাকশন মেনু
        showStudentActions: async (uid, userName, isBlocked, isDisabled) => {
            const { value: action } = await Swal.fire({
                title: `Manage: ${userName}`,
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <p class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Account Status</p>
                            <div class="space-y-2">
                                <label class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border dark:border-slate-700">
                                    <span class="text-sm">Block Student</span>
                                    <input type="checkbox" id="block-toggle" class="toggle-switch" ${isBlocked ? 'checked' : ''}>
                                </label>
                                <label class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border dark:border-slate-700">
                                    <span class="text-sm">Disable Account</span>
                                    <input type="checkbox" id="disable-toggle" class="toggle-switch" ${isDisabled ? 'checked' : ''}>
                                </label>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            Blocked students cannot login. Disabled students cannot take exams.
                        </p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                confirmButtonColor: '#1d4ed8',
                cancelButtonText: 'Cancel',
                showCloseButton: true,
                customClass: {
                    popup: 'rounded-2xl',
                    confirmButton: 'px-4 py-2.5',
                    cancelButton: 'px-4 py-2.5'
                },
                preConfirm: () => {
                    const blockToggle = document.getElementById('block-toggle').checked;
                    const disableToggle = document.getElementById('disable-toggle').checked;
                    return { block: blockToggle, disable: disableToggle };
                }
            });

            if (action) {
                try {
                    await updateDoc(doc(db, "users", uid), {
                        blocked: action.block,
                        disabled: action.disable,
                        lastUpdated: new Date()
                    });
                    
                    Swal.fire({
                        title: 'Success!',
                        text: `Student ${userName} has been ${action.block ? 'blocked' : action.disable ? 'disabled' : 'activated'}.`,
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false,
                        timerProgressBar: true
                    });
                    
                    // Refresh student list
                    Teacher.usersView();
                } catch (error) {
                    Swal.fire('Error', 'Failed to update student: ' + error.message, 'error');
                }
            }
        },
        
        startDemo: () => { 
            AppState.isDemo = true; 
            document.getElementById('teacher-nav').classList.add('hidden'); 
            document.getElementById('teacher-header').classList.add('hidden'); 
            document.getElementById('app-container').classList.remove('pt-16'); 
            document.getElementById('student-nav').classList.remove('hidden'); 
            document.getElementById('student-nav').classList.add('flex'); 
            document.getElementById('demo-exit-btn').classList.remove('hidden'); 
            Student.loadDashboard(); 
        },
        
        exitDemo: () => { 
            AppState.isDemo = false; 
            document.getElementById('student-nav').classList.add('hidden'); 
            document.getElementById('demo-exit-btn').classList.add('hidden'); 
            Router.initTeacher(); 
        }
    };
    window.Teacher = Teacher;

    const loadUserSession = async (user) => {
        if(!db) {
            Swal.fire("System Error", "Database connection not available.", "error");
            return;
        }
        
        try {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            
            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                
                // Check if user is blocked
                if (userData.blocked) {
                    await signOut(auth);
                    Swal.fire({
                        title: 'Account Blocked',
                        text: 'Your account has been blocked by a teacher.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Initialize student panel with user data
                Router.initStudent(userData);
                
                // Listen for user updates (like blocking)
                const unsub = onSnapshot(userDocRef, (updatedDoc) => {
                    if (updatedDoc.exists() && updatedDoc.data().blocked) {
                        unsub();
                        Swal.fire({
                            title: 'Account Blocked',
                            text: 'Your account was just blocked by a teacher.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            Auth.logout();
                        });
                    }
                });
                
                unsubscribes.push(unsub);
                
            } else {
                // User document doesn't exist, create one
                console.log("Creating user document for:", user.uid);
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    name: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    role: 'student',
                    blocked: false,
                    disabled: false,
                    joined: new Date(),
                    createdAt: new Date()
                });
                
                // Retry loading session
                setTimeout(() => {
                    loadUserSession(user);
                }, 1000);
            }
            
        } catch (error) {
            console.error("Error loading user session:", error);
            Swal.fire({
                title: 'Error',
                text: 'Could not load your user data. Please try logging in again.',
                icon: 'error',
                confirmButtonText: 'OK'
            }).then(() => {
                Auth.logout();
            });
        }
    };

    // Helper function to refresh exam cache
    async function refreshExamCache() {
        try {
            const snap = await getDocs(query(collection(db, "exams"), orderBy("createdAt", "desc")));
            window.ExamCache = {}; 
            snap.forEach(d => { 
                window.ExamCache[d.id] = { id: d.id, ...d.data() }; 
            });
        } catch (error) {
            console.error("Error refreshing exam cache:", error);
        }
    }

    function attachAppListeners() {
        console.log("Attaching app listeners...");
        
        // Login Buttons
        const sLoginBtn = document.getElementById('s-login-btn');
        const sSignupBtn = document.getElementById('s-signup-btn');
        const tLoginBtn = document.getElementById('t-login-btn');
        const tSignupBtn = document.getElementById('t-signup-btn');
        
        if (sLoginBtn) {
            sLoginBtn.addEventListener('click', Auth.studentLogin);
            console.log("Student login button attached");
        }
        
        if (sSignupBtn) {
            sSignupBtn.addEventListener('click', Auth.studentSignup);
            console.log("Student signup button attached");
        }
        
        if (tLoginBtn) {
            tLoginBtn.addEventListener('click', Auth.teacherLogin);
            console.log("Teacher login button attached");
        }
        
        if (tSignupBtn) {
            tSignupBtn.addEventListener('click', Auth.teacherSignup);
            console.log("Teacher signup button attached");
        }

        // Teacher Header
        const teacherDemoBtn = document.getElementById('teacher-demo-btn');
        const teacherLogoutBtn = document.getElementById('teacher-logout-btn');
        
        if (teacherDemoBtn) {
            teacherDemoBtn.addEventListener('click', Teacher.startDemo);
        }
        
        if (teacherLogoutBtn) {
            teacherLogoutBtn.addEventListener('click', Auth.confirmLogout);
        }

        // Navigations
        const studentNav = document.getElementById('student-nav');
        const teacherNav = document.getElementById('teacher-nav');
        
        if (studentNav) {
            studentNav.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button');
                if (targetButton && targetButton.dataset.route) {
                    Router.student(targetButton.dataset.route);
                }
            });
        }
        
        if (teacherNav) {
            teacherNav.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button');
                if (targetButton && targetButton.dataset.route) {
                    Router.teacher(targetButton.dataset.route);
                }
            });
        }
        
        const exitDemoBtn = document.getElementById('demo-exit-actual-btn');
        if (exitDemoBtn) {
            exitDemoBtn.addEventListener('click', Teacher.exitDemo);
        }
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM loaded, initializing...");
        attachAppListeners();
        
        // Check for existing session
        if (localStorage.getItem('teacher_sess')) {
            console.log("Found teacher session in localStorage");
            AppState.role = 'teacher';
            Router.initTeacher();
        } else if (auth) {
            // Check for user authentication state
            onAuthStateChanged(auth, (user) => {
                console.log("Auth state changed:", user ? "User logged in" : "No user");
                
                if (user) {
                    if (!AppState.user) {
                        console.log("Loading user session for:", user.email);
                        loadUserSession(user);
                    }
                } else if (AppState.role !== 'teacher') {
                    // No user and not teacher, show auth screen
                    console.log("No active session, showing auth screen");
                    AppState.user = null;
                    AppState.role = 'guest';
                    
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('auth-screen').classList.add('flex');
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('student-nav').classList.add('hidden');
                    document.getElementById('teacher-nav').classList.add('hidden');
                    document.getElementById('teacher-header').classList.add('hidden');
                }
            }, (error) => {
                console.error("Auth state change error:", error);
                Swal.fire("Auth Error", "Authentication system error. Please refresh.", "error");
            });
        }
        
        // Test Firebase connection
        if (db) {
            console.log("Firebase connection test passed");
        } else {
            console.error("Firebase connection failed");
        }
    });

    // Export for debugging
    window.debug = {
        AppState,
        auth,
        db,
        clearListeners,
        Router,
        Auth
    };
</script>
</body>
</html>
